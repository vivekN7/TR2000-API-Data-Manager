# üî¥ CRITICAL: START HERE FOR NEXT SESSION (Session 28)

## üéØ SESSION 27 COMPLETE - DOCUMENTATION REFACTOR & RAW_JSON ARCHITECTURE ANALYSIS COMPLETE!

### üèÜ **SESSION 27 ACHIEVEMENTS:**
**Documentation Cleanup Complete:**
- ‚úÖ **Archived old documentation**: Moved 1000+ lines of Sessions 1-25 to `/backup_session26/`
- ‚úÖ **Streamlined current docs**: Clean, focused documentation on Sessions 24-27
- ‚úÖ **Identified critical architecture issue**: GPT-5 analysis revealed RAW_JSON is broken
- ‚úÖ **Ready for Session 28**: Clear priorities and implementation plan established

### üìÖ **CRITICAL ARCHITECTURE ISSUE IDENTIFIED:**
**RAW_JSON Flow BROKEN - Industry Standards Violation:**
- **Current (Wrong)**: API ‚Üí STG_TABLES ‚Üí ISSUES (bypassing RAW_JSON entirely)
- **Should Be (GPT-5 Standard)**: API ‚Üí RAW_JSON ‚Üí STG_TABLES ‚Üí ISSUES
- **Root Cause**: C# sends 7 parameters, Oracle procedure expects 4 parameters
- **Impact**: No audit trail, no replay capability, missing core ETL benefits

## ‚úÖ **SESSION 27 COMPLETE - READY FOR RAW_JSON REFACTOR!**

### **CURRENT PRODUCTION STATUS:**
**Smart Workflow Working Perfectly:**
- **Application**: ‚úÖ http://localhost:5005/etl-operations
- **Smart Workflow**: ‚úÖ 98.5% API call reduction operational  
- **LoadOperators**: ‚úÖ Working (8 records)
- **LoadPlants**: ‚úÖ Working (130 records basic + enhanced selected)
- **LoadIssues**: ‚úÖ Working (validates Plant Loader ‚Üí enhances plants ‚Üí loads issues)
- **Date Parsing**: ‚úÖ All European formats handled with PARSE_TR2000_DATE()
- **Plant Enhancement**: ‚úÖ EnhancePlantsWithDetailedData() fully operational
- **Documentation**: ‚úÖ Clean, focused, current (Session 27 refactor complete)

**Critical Issue:**
- ‚ùå **RAW_JSON**: Broken architecture - bypassing audit layer entirely

## üöß **SESSION 28 IMMEDIATE PRIORITIES:**

### **PRIORITY #1: RAW_JSON Architecture Refactor** üö® **CRITICAL**

#### **1.1 Fix Oracle RAW_JSON Table Design**
**Current Problems:**
- Uses BLOB storage without JSON validation
- Missing critical metadata (processed flag, hash, request context)
- Only 4 parameters vs industry standard metadata capture

**GPT-5 Recommended Structure:**
```sql
CREATE TABLE RAW_JSON (
  JSON_ID            NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  ETL_RUN_ID         NUMBER,
  ENDPOINT_NAME      VARCHAR2(100) NOT NULL,
  REQUEST_URL        VARCHAR2(1000),
  REQUEST_PARAMS     CLOB,
  RESPONSE_STATUS    NUMBER,
  PLANT_ID           VARCHAR2(50),
  CREATED_DATE       TIMESTAMP(6) DEFAULT SYSTIMESTAMP NOT NULL,
  JSON_DATA          CLOB CHECK (JSON_DATA IS JSON),
  RESP_HASH_SHA256   RAW(32) NOT NULL,
  PROCESSED_FLAG     CHAR(1) DEFAULT 'N' CHECK (PROCESSED_FLAG IN ('Y','N'))
);
```

#### **1.2 Update SP_INSERT_RAW_JSON Procedure**
**Fix Parameter Mismatch:**
- **Current**: 4 parameters (ETL_RUN_ID, ENDPOINT_NAME, PLANT_ID, JSON_DATA)
- **C# Expects**: 7 parameters (endpoint, keyString, etlRunId, httpStatus, durationMs, headers, payload)
- **Solution**: Update Oracle procedure to accept comprehensive metadata

#### **1.3 Implement Proper Data Flow**
**Change Architecture From:**
```
C# API Service ‚Üí STG_TABLES ‚Üí Oracle SCD2 Processing
```

**To Industry Standard:**
```
C# API Service ‚Üí RAW_JSON ‚Üí STG_TABLES (via JSON_TABLE) ‚Üí Oracle SCD2 Processing
```

### **PRIORITY #2: Update C# ETL Flow** üîß

#### **2.1 Modify ETL Process**
1. **Step 1**: API call ‚Üí Insert to RAW_JSON (comprehensive metadata)
2. **Step 2**: Parse RAW_JSON ‚Üí STG_TABLES using Oracle JSON_TABLE
3. **Step 3**: STG_TABLES ‚Üí Final dimension tables (existing SCD2 process)

#### **2.2 Add Deduplication & Replay**
- Hash-based deduplication in RAW_JSON
- Processed flag management
- Replay capability from RAW_JSON for data issues

### **PRIORITY #3: Test Complete New Architecture** ‚úÖ

#### **3.1 Validation Steps**
1. Test RAW_JSON insertion with full metadata
2. Test JSON_TABLE parsing from RAW_JSON to staging
3. Verify existing SCD2 processing still works
4. Validate audit trail and replay capability
5. Confirm Smart Workflow still achieves 98.5% API reduction

## üîó **APPLICATION STATUS:**
- **URL**: ‚úÖ http://localhost:5005/etl-operations (Working perfectly)
- **Build Status**: ‚úÖ Production ready, 0 errors
- **Core ETL**: ‚úÖ All working (just bypassing RAW_JSON layer)
- **Smart Workflow**: ‚úÖ 98.5% API reduction operational
- **Ready for Refactor**: ‚úÖ No breaking changes to existing functionality

## üìã **IMPLEMENTATION APPROACH:**

### **Phase 1: Oracle DDL Updates**
1. Update RAW_JSON table structure (new columns, CLOB storage, JSON validation)
2. Update SP_INSERT_RAW_JSON procedure (accept 7 parameters vs current 4)
3. Create JSON_TABLE parsing procedures (RAW_JSON ‚Üí STG_TABLES)

### **Phase 2: C# Code Updates**
1. Fix InsertRawJson method to work with updated procedure
2. Update ETL flow to parse from RAW_JSON instead of direct API calls
3. Add processed flag management

### **Phase 3: Testing & Validation**
1. Test new architecture end-to-end
2. Validate audit trail functionality
3. Test replay capability
4. Ensure Smart Workflow performance maintained

## üîÑ **QUICK RECOVERY COMMANDS FOR SESSION 28:**

```bash
# 1. Start application (Smart workflow fully operational)
cd /workspace/TR2000/TR2K/TR2KApp
/home/node/.dotnet/dotnet run --urls "http://0.0.0.0:5005"

# 2. Access ETL Operations page
http://localhost:5005/etl-operations

# 3. CURRENT STATUS: Ready for RAW_JSON architecture refactor!
# - Core ETL: ‚úÖ Working perfectly
# - Smart workflow: ‚úÖ 98.5% API reduction operational
# - Documentation: ‚úÖ Clean and focused (Session 27 refactor complete)
# - Next task: Implement proper API ‚Üí RAW_JSON ‚Üí STG ‚Üí CORE flow
```

## üóÉÔ∏è **KEY FILES FOR SESSION 28:**

### **DDL to Update:**
- `/Ops/Master_DDL_Script.sql` - Update RAW_JSON table and SP_INSERT_RAW_JSON procedure

### **C# to Update:**
- `/TR2KBlazorLibrary/Logic/Services/OracleETLServiceV2.cs` - Fix InsertRawJson method
- Update ETL flow to use RAW_JSON ‚Üí STG pattern

### **New Documentation:**
- `/Ops/DB_Design/RAW_JSON_Architecture.md` - GPT-5's recommended structure
- `/Ops/DB_Design/Current_Issues_Analysis.md` - Parameter mismatch details
- `/Ops/DB_Design/Migration_Plan.md` - Implementation steps

## üí° **EXPECTED BENEFITS AFTER REFACTOR:**
1. **Industry Standard Architecture**: Proper API ‚Üí RAW_JSON ‚Üí STG ‚Üí CORE flow
2. **Complete Audit Trail**: Every API response captured with metadata
3. **Replay Capability**: Re-process data without hitting API again
4. **Deduplication**: Hash-based duplicate prevention
5. **Performance**: Smart Workflow 98.5% API reduction maintained
6. **Compliance**: Follows GPT-5 recommended ETL patterns

---
**Last Updated:** 2025-08-21 Session 27 Complete
**Status:** Documentation refactored, RAW_JSON architecture issue identified and analyzed
**Next Session Priority:** Implement proper RAW_JSON architecture per GPT-5 recommendations
**Ready for Session 28:** ‚úÖ All analysis complete, implementation plan ready