# TR2000 SCD2 Implementation - Final Decision Document

## Executive Summary
After extensive analysis and consultation, we have reached consensus on a production-ready SCD2 implementation that is:
- **Oracle-centric** - All business logic lives in the database
- **Complete** - Handles 100% of data change scenarios
- **Optimized** - Uses set-based operations, no loops
- **Maintainable** - Clear separation of concerns, testable

## Architecture Philosophy

### C# Responsibilities (Minimal)
1. Fetch data from API
2. Insert into staging tables or RAW_JSON
3. Call Oracle stored procedures
4. Return status to UI

### Oracle Responsibilities (Everything Else)
1. Deduplication
2. Validation
3. SCD2 temporal logic
4. Error handling
5. Audit logging
6. Reconciliation
7. Data transformations
8. Deletion cascade based on ETL_PLANT_LOADER scope

## Core Components

### 1. **Staging Tables with Proper Structure**
```sql
-- All staging tables include:
STG_ID NUMBER GENERATED BY DEFAULT AS IDENTITY  -- For deterministic dedup
IS_DUPLICATE CHAR(1) DEFAULT 'N'                -- Dedup flag
IS_VALID CHAR(1) DEFAULT 'Y'                    -- Validation flag
VALIDATION_ERROR VARCHAR2(500)                  -- Error details
ETL_RUN_ID NUMBER                               -- Batch tracking
```

### 2. **SCD2 Dimension Tables**
```sql
-- All dimension tables include:
VALID_FROM DATE                  -- When record became active
VALID_TO DATE                     -- When record became inactive
IS_CURRENT CHAR(1)               -- Quick current record lookup
CHANGE_TYPE VARCHAR2(20)         -- INSERT/UPDATE/DELETE/REACTIVATE
DELETE_DATE DATE                 -- When deleted from source
SRC_HASH RAW(32)                -- Oracle STANDARD_HASH for change detection
ETL_RUN_ID NUMBER                -- Audit trail
```

### 3. **Master Orchestrator Pattern**
```sql
SP_PROCESS_ETL_BATCH
  ├── SP_DEDUPLICATE_STAGING      -- Remove duplicates
  ├── PKG_*_ETL.VALIDATE          -- Business rules
  ├── PKG_*_ETL.PROCESS_SCD2      -- Temporal logic
  ├── PKG_*_ETL.RECONCILE         -- Count verification
  └── COMMIT (single, atomic)     -- All or nothing
```

## Key Design Decisions

### ✅ **INCLUDED Features**

1. **Deduplication via ROW_NUMBER()**
   - Deterministic using STG_ID identity column
   - Handles duplicates from API gracefully

2. **Complete SCD2 Coverage**
   - INSERT: New records
   - UPDATE: Changed records (new version created)
   - DELETE: Soft delete when missing from source
   - REACTIVATE: Deleted records that return

3. **Minimal RAW_JSON Layer** ✅ IMPLEMENTED
   - SecureFiles compression (60-80% reduction)
   - 30-day retention with auto-purge (no DBA required!)
   - Best-effort inserts (failures don't break ETL)
   - Cleanup runs after each ETL (not scheduled job)

4. **RBAC Security**
   - Role-based access control
   - Optional triggers on critical tables
   - No manual DML allowed

5. **Atomic Transactions**
   - Single COMMIT in orchestrator
   - Autonomous transactions for error logging
   - Errors always logged even on rollback

6. **Performance Optimizations**
   - Set-based operations only
   - Partial indexes on IS_CURRENT
   - Bulk operations from C#

### ❌ **EXCLUDED (Overengineering)**

1. **Complex Crosswalk Tables** - Keys are stable enough
2. **Full JSON Parsing Every Time** - Direct mapping works
3. **ILM Policies** - Simple DELETE job sufficient
4. **Separate REJECT Tables** - ETL_ERROR_LOG handles this
5. **Row-by-Row Processing** - Always use set-based

## Deletion Cascade Pattern (Session 14 Addition)

### ETL_PLANT_LOADER as Single Source of Truth
The ETL_PLANT_LOADER table defines the scope of all ETL operations. Plants in this table are considered "active" and their data is processed. When a plant is removed from the loader:

1. **Issues Deletion Cascade**: All issues for removed plants are marked as deleted
2. **Downstream Impact**: Reference tables only process issues with IS_CURRENT='Y'
3. **Reactivation**: Adding a plant back to the loader will reactivate its issues

### Implementation in PKG_ISSUES_ETL
```sql
-- Step 1: Mark issues deleted for plants NOT in loader
UPDATE ISSUES 
SET IS_CURRENT = 'N', DELETE_DATE = SYSDATE, CHANGE_TYPE = 'DELETE'
WHERE IS_CURRENT = 'Y'
AND PLANT_ID NOT IN (SELECT PLANT_ID FROM ETL_PLANT_LOADER)

-- Step 2: Process issues for plants IN loader (existing logic)
```

### Benefits
- **Clean Scope Control**: ETL_PLANT_LOADER defines what's in scope
- **No Orphaned Data**: Removed plants don't cause unnecessary API calls
- **Full History**: All changes tracked with SCD2
- **Reversible**: Plants can be added back, issues reactivated

## Performance Expectations

With TR2000's data volumes:
- **Operators**: < 1 second (~10 records)
- **Plants**: < 2 seconds (~130 records)
- **Issues**: < 10 seconds (~500 records)
- **Total ETL**: < 30 seconds for all entities

API calls dominate (95% of time), not database operations (5%).

## Implementation Checklist

### Phase 1: Foundation ✅ COMPLETE
- [x] Deploy new DDL with complete SCD2 structure
- [x] Add STG_ID identity columns to staging tables
- [x] Create entity-specific packages (PKG_*_ETL)
- [x] Implement master orchestrator procedure
- [x] Add RAW_JSON with zero-privilege cleanup
- [x] Implement SP_PURGE_RAW_JSON and SP_INSERT_RAW_JSON
- [x] Update C# to insert into RAW_JSON
- [x] Set up autonomous error logging (LOG_ETL_ERROR)
- [x] Add all 6 reference type packages (VDS, EDS, MDS, VSK, ESK, PIPE_ELEMENT)
- [x] Implement automatic recompilation for circular dependencies

### Phase 2: Safety (Next Sprint)
- [ ] Configure RBAC roles
- [ ] Add reconciliation views
- [ ] Enable DBMS_APPLICATION_INFO instrumentation

### Phase 3: Monitoring (Future)
- [ ] Daily reconciliation reports
- [ ] Performance baselines
- [ ] Alert thresholds
- [ ] Audit reports

## Files to Use

### Production DDL
- `Oracle_DDL_SCD2_FINAL.sql` - Complete implementation with all fixes
  - **IMPORTANT**: Includes automatic recompilation section at end
  - Handles circular dependencies automatically
  - Safe to share - no manual intervention required
  - Shows status report of all objects after creation

### Test Scripts
- `Test_SCD2_Complete_Scenarios.sql` - Validates all scenarios

### Documentation
- `SCD2_FINAL_DECISION.md` - This document
- `TR2K_PROGRESS.md` - Development history
- `TR2K_START_HERE.md` - Quick start guide

## Risk Mitigation

1. **Data Loss**: Impossible - soft deletes only
2. **Corruption**: Self-healing via hash comparison
3. **Duplicates**: Handled via ROW_NUMBER() dedup
4. **Manual Changes**: Blocked via RBAC/triggers
5. **Failed ETL**: Atomic rollback, errors logged

## Sign-Off

This design has been reviewed and incorporates feedback from:
- Initial implementation (Session 9-10)
- GPT-5 consultation on industry standards
- Final production readiness review

**Status**: ✅ **APPROVED FOR IMPLEMENTATION**

---
*Last Updated: 2025-01-17*
*Next Step: Begin implementation of Phase 1 Foundation*