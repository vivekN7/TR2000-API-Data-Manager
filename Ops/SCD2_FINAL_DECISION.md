# TR2000 SCD2 Implementation - Final Decision Document

## Executive Summary
After extensive analysis and consultation with GPT-5, we have reached consensus on a production-ready SCD2 implementation that is:
- **Oracle-centric** - All business logic lives in the database
- **Industry Standard** - Proper API → RAW_JSON → STG → CORE flow
- **Complete** - Handles 100% of data change scenarios with complete field coverage
- **Optimized** - Uses set-based operations, no loops
- **Maintainable** - Clear separation of concerns, testable

## 🚨 **CRITICAL ARCHITECTURE ISSUE IDENTIFIED (Session 27)**

### **Current Implementation Problem:**
**GPT-5 Analysis Revealed Fundamental Architecture Violation:**
- **Current (Wrong)**: API → STG_TABLES → ISSUES (bypassing RAW_JSON entirely)
- **Industry Standard**: API → RAW_JSON → STG_TABLES → ISSUES
- **Root Cause**: Parameter mismatch between C# (7 params) and Oracle procedure (4 params)
- **Impact**: No audit trail, no replay capability, missing core ETL benefits

### **GPT-5 Recommended Solution:**
The RAW_JSON layer must be the **first landing point** for all API data, providing:
- **Immutable audit trail** - Every API response preserved
- **Replay capability** - Re-process without API calls
- **Deduplication** - Hash-based duplicate prevention
- **Schema drift safety** - New fields captured automatically
- **Lineage tracking** - Every record traceable to source

## Architecture Philosophy

### C# Responsibilities (Minimal - Data Mover Only)
1. Fetch data from API
2. Insert into RAW_JSON with comprehensive metadata
3. Trigger Oracle processing procedures
4. Return status to UI

### Oracle Responsibilities (Everything Else)
1. **RAW_JSON Management** - Store, deduplicate, manage processed flags
2. **JSON Parsing** - RAW_JSON → STG_TABLES using JSON_TABLE
3. **Deduplication** - Remove duplicates within staging
4. **Validation** - Business rule validation
5. **SCD2 temporal logic** - Temporal tracking in dimension tables
6. **Error handling** - Comprehensive error logging
7. **Audit logging** - Complete audit trail
8. **Reconciliation** - Count verification
9. **Data transformations** - Date parsing, data type conversions

## Core Components

### 1. **RAW_JSON Table (GPT-5 Enhanced Design)**
```sql
CREATE TABLE RAW_JSON (
  JSON_ID            NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  ETL_RUN_ID         NUMBER,
  ENDPOINT_NAME      VARCHAR2(100) NOT NULL,
  REQUEST_URL        VARCHAR2(1000),
  REQUEST_PARAMS     CLOB,
  RESPONSE_STATUS    NUMBER,
  PLANT_ID           VARCHAR2(50),
  CREATED_DATE       TIMESTAMP(6) DEFAULT SYSTIMESTAMP NOT NULL,
  JSON_DATA          CLOB CHECK (JSON_DATA IS JSON),
  RESP_HASH_SHA256   RAW(32) NOT NULL,
  PROCESSED_FLAG     CHAR(1) DEFAULT 'N' CHECK (PROCESSED_FLAG IN ('Y','N'))
);

CREATE INDEX IX_RAWJSON_PICK
  ON RAW_JSON (ENDPOINT_NAME, PROCESSED_FLAG, CREATED_DATE);
```

### 2. **Staging Tables with Proper Structure**
```sql
-- All staging tables include:
STG_ID NUMBER GENERATED BY DEFAULT AS IDENTITY  -- For deterministic dedup
RAW_JSON_ID NUMBER                              -- Link back to source
IS_DUPLICATE CHAR(1) DEFAULT 'N'                -- Dedup flag
IS_VALID CHAR(1) DEFAULT 'Y'                    -- Validation flag
VALIDATION_ERROR VARCHAR2(500)                  -- Error details
ETL_RUN_ID NUMBER                               -- Batch tracking
```

### 3. **SCD2 Dimension Tables**
```sql
-- All dimension tables include:
VALID_FROM DATE                  -- When record became active
VALID_TO DATE                    -- When record became inactive
IS_CURRENT CHAR(1)               -- Quick current record lookup
CHANGE_TYPE VARCHAR2(20)         -- INSERT/UPDATE/DELETE/REACTIVATE
DELETE_DATE DATE                 -- When deleted from source
SRC_HASH RAW(32)                -- Oracle STANDARD_HASH for change detection
SRC_RAW_JSON_ID NUMBER           -- Lineage back to RAW_JSON
ETL_RUN_ID NUMBER                -- Audit trail
```

### 4. **Master Orchestrator Pattern (Updated)**
```sql
SP_PROCESS_ETL_BATCH
  ├── Parse RAW_JSON → STG_TABLES (JSON_TABLE)
  ├── SP_DEDUPLICATE_STAGING      -- Remove duplicates
  ├── PKG_*_ETL.VALIDATE          -- Business rules
  ├── PKG_*_ETL.PROCESS_SCD2      -- Temporal logic
  ├── PKG_*_ETL.RECONCILE         -- Count verification
  ├── Update RAW_JSON processed flags
  └── COMMIT (single, atomic)     -- All or nothing
```

## Key Design Decisions

### ✅ **INCLUDED Features**

1. **Proper Data Flow (GPT-5 Standard)**
   ```
   API → RAW_JSON (immutable) → STG_* (parsed) → DIM_* (SCD2)
   ```

2. **RAW_JSON as Single Source of Truth**
   - All API responses stored with metadata
   - Hash-based deduplication
   - Processed flag management
   - 30-day retention with auto-purge

3. **JSON_TABLE Parsing**
   - Parse RAW_JSON → STG_TABLES using Oracle JSON_TABLE
   - Handle nested JSON structures
   - Maintain lineage to source RAW_JSON record

4. **Complete SCD2 Coverage**
   - INSERT: New records
   - UPDATE: Changed records (new version created)
   - DELETE: Soft delete when missing from source
   - REACTIVATE: Deleted records that return

5. **Comprehensive Audit Trail**
   - Every dimension record links back to RAW_JSON source
   - Complete lineage tracking
   - Replay capability for debugging

6. **Performance Optimizations**
   - Set-based operations only
   - Partial indexes on IS_CURRENT and PROCESSED_FLAG
   - Bulk operations from C#
   - JSON search indexes on RAW_JSON

### ❌ **EXCLUDED (Overengineering)**

1. **Complex Crosswalk Tables** - Keys are stable enough
2. **Row-by-Row Processing** - Always use set-based
3. **ILM Policies** - Simple DELETE job sufficient
4. **Separate REJECT Tables** - ETL_ERROR_LOG handles this

## Enhanced Data Flow (Post Session 27)

### 1. **Ingestion Process**
```sql
-- C# calls enhanced SP_INSERT_RAW_JSON
SP_INSERT_RAW_JSON(
  p_etl_run_id    => :etlRunId,
  p_endpoint      => :endpoint,
  p_request_url   => :requestUrl,
  p_request_params => :requestParams,
  p_response_status => :httpStatus,
  p_plant_id      => :plantId,
  p_json_data     => :jsonData,
  p_duration_ms   => :durationMs,
  p_headers       => :headers
);
```

### 2. **Parsing Process**
```sql
-- Parse RAW_JSON to staging using JSON_TABLE
INSERT INTO STG_ISSUES (RAW_JSON_ID, PLANT_ID, ISSUE_REVISION, ...)
SELECT 
  r.JSON_ID,
  jt.plant_id,
  jt.issue_revision,
  ...
FROM RAW_JSON r
CROSS APPLY JSON_TABLE(
  r.JSON_DATA,
  '$[*]'
  COLUMNS (
    plant_id        VARCHAR2(50)  PATH '$.PlantID',
    issue_revision  VARCHAR2(50)  PATH '$.IssueRevision',
    ...
  )
) jt
WHERE r.ENDPOINT_NAME = 'plants/*/issues'
  AND r.PROCESSED_FLAG = 'N';
```

### 3. **SCD2 Processing (Existing - No Changes)**
```sql
-- Existing PKG_*_ETL packages process STG → DIM tables
-- This layer remains unchanged - only source changes from API to RAW_JSON
```

## Implementation Checklist

### Phase 1: RAW_JSON Architecture Fix (Session 28) 🚨 **PRIORITY**
- [ ] Update RAW_JSON table structure (add metadata columns)
- [ ] Update SP_INSERT_RAW_JSON procedure (accept 7+ parameters)
- [ ] Create JSON_TABLE parsing procedures
- [ ] Update C# InsertRawJson method
- [ ] Test RAW_JSON → STG flow

### Phase 2: Full Integration (Session 29)
- [ ] Update all ETL methods to use RAW_JSON → STG flow
- [ ] Add processed flag management
- [ ] Implement replay capability
- [ ] Add deduplication logic

### Phase 3: Testing & Validation (Session 30)
- [ ] End-to-end testing of new architecture
- [ ] Performance validation (maintain 98.5% API reduction)
- [ ] Audit trail validation
- [ ] Replay functionality testing

## Files to Update (Session 28)

### Production DDL
- `Master_DDL_Script.sql` - **Update RAW_JSON table and SP_INSERT_RAW_JSON**

### C# Code
- `OracleETLServiceV2.cs` - **Fix InsertRawJson method parameter mismatch**

### New Documentation (Session 27 Created)
- `DB_Design/RAW_JSON_Architecture.md` - GPT-5's recommended structure
- `DB_Design/Current_Issues_Analysis.md` - Parameter mismatch details
- `DB_Design/Migration_Plan.md` - Implementation steps

## Expected Benefits

### Technical Benefits
1. **Industry Standard Architecture** - Follows GPT-5 recommended patterns
2. **Complete Audit Trail** - Every API response captured with metadata
3. **Replay Capability** - Re-process data without hitting API again
4. **Deduplication** - Hash-based duplicate prevention
5. **Schema Drift Safety** - New API fields captured automatically
6. **Lineage Tracking** - Every record traceable to source

### Performance Benefits
1. **Smart Workflow Maintained** - 98.5% API reduction preserved
2. **Reduced API Dependency** - Replay from RAW_JSON for debugging
3. **Efficient Parsing** - Oracle JSON_TABLE performance
4. **Optimized Storage** - JSON compression in RAW_JSON

### Operational Benefits
1. **Better Debugging** - Complete API response history
2. **Data Recovery** - Replay specific time periods
3. **Compliance** - Full audit trail for regulatory requirements
4. **Monitoring** - Comprehensive ETL metrics and lineage

## Risk Mitigation

1. **Data Loss**: Impossible - RAW_JSON preserves everything
2. **Performance Impact**: Minimal - JSON_TABLE is efficient
3. **Storage Growth**: Managed - 30-day retention with compression
4. **Complexity**: Controlled - Clear separation of concerns
5. **Failed ETL**: Enhanced - Better debugging with RAW_JSON history

## Sign-Off

This design has been reviewed and incorporates feedback from:
- Initial implementation (Sessions 9-26)
- **GPT-5 consultation on industry standards (Session 27)**
- Smart Workflow operational experience (Sessions 24-26)
- European date parsing resolution (Session 26)

**Status**: ✅ **READY FOR RAW_JSON ARCHITECTURE REFACTOR**

---
*Last Updated: 2025-08-21 (Session 27 - GPT-5 Analysis & Documentation Refactor)*
*Current State: Smart Workflow operational, RAW_JSON architecture issue identified*
*Next Step: Implement proper API → RAW_JSON → STG → CORE flow per GPT-5 recommendations*