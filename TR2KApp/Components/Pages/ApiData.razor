@page "/api-data"
@rendermode InteractiveServer
@using TR2KBlazorLibrary.Logic.Services
@using TR2KBlazorLibrary.Models
@using TR2KBlazorLibrary.Models.DatabaseModels
@using System.Text
@inject TR2000ApiService ApiService
@inject DataImportService ImportService
@inject ApiResponseDeserializer Deserializer
@inject IJSRuntime JS

<PageTitle>TR2000 API Data</PageTitle>

<h1>TR2000 API Data Manager</h1>

<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h5>Import TR2000 Data</h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label class="form-label">1. Select Endpoint:</label>
                    <select class="form-select" @bind="SelectedEndpointKey" @bind:after="OnEndpointChanged">
                        <option value="">Choose endpoint...</option>
                        @foreach (var group in EndpointRegistry.AllEndpoints.GroupBy(e => e.Section))
                        {
                            <optgroup label="@group.Key">
                                @foreach (var endpoint in group)
                                {
                                    <option value="@endpoint.Key">@endpoint.Name - @endpoint.Description</option>
                                }
                            </optgroup>
                        }
                    </select>
                </div>
                
                @if (SelectedEndpoint != null && SelectedEndpoint.Parameters.Any())
                {
                    <div class="mb-3">
                        <label class="form-label">2. Enter Parameters:</label>
                        <div class="row">
                        @foreach (var param in SelectedEndpoint.Parameters)
                            {
                                <div class="col-md-4">
                                    <label class="form-label small">
                                        @param.DisplayName
                                        @if (param.IsRequired)
                                        {
                                            <span class="text-danger">*</span>
                                        }
                                    </label>
                                    @if (param.Type == "dropdown" && param.DropdownSource != null)
                                    {
                                        <select class="form-select form-select-sm" 
                                                value="@GetParameterValue(param.Name)"
                                                @onchange="@(e => SetParameterValue(param.Name, e.Value?.ToString() ?? ""))"
                                                disabled="@(!DropdownData.ContainsKey(param.DropdownSource))">
                                            <option value="">Choose...</option>
                                            @if (DropdownData.ContainsKey(param.DropdownSource))
                                            {
                                                @foreach (var item in DropdownData[param.DropdownSource])
                                                {
                                                    var valueField = GetDropdownValue(item, param.ValueField);
                                                    var displayField = GetDropdownDisplay(item, param.DisplayField);
                                                    <option value="@valueField">@displayField</option>
                                                }
                                            }
                                        </select>
                                    }
                                    else if (param.Type == "int")
                                    {
                                        <input type="number" class="form-control form-control-sm" 
                                               value="@GetParameterValue(param.Name)"
                                               @onchange="@(e => SetParameterValue(param.Name, e.Value?.ToString() ?? ""))"
                                               placeholder="Enter @param.DisplayName" />
                                    }
                                    else
                                    {
                                        <input type="text" class="form-control form-control-sm" 
                                               value="@GetParameterValue(param.Name)"
                                               @onchange="@(e => SetParameterValue(param.Name, e.Value?.ToString() ?? ""))"
                                               placeholder="Enter @param.DisplayName" />
                                    }
                                </div>
                            }
                        </div>
                    </div>
                }
                
                <div class="mb-3">
                    <button class="btn btn-primary me-2" 
                            @onclick="TestConnection" 
                            disabled="@(!CanImport())">
                        @(IsTesting ? "Testing..." : "Test Connection")
                    </button>
                    <button class="btn btn-success" 
                            @onclick="ImportData" 
                            disabled="@(!CanImport())">
                        @(IsImporting ? "Importing..." : "Import Data")
                    </button>
                    
                    @if (ShowViewData)
                    {
                        <button class="btn btn-warning ms-2" @onclick="ExportToCsv">
                            Export to CSV
                        </button>
                    }
                </div>
                
                @if (!string.IsNullOrEmpty(StatusMessage))
                {
                    <div class="alert @GetAlertClass()" role="alert">
                        @StatusMessage
                    </div>
                }
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        @if (SelectedEndpoint != null)
        {
            <div class="card">
                <div class="card-header">
                    <h6>Endpoint Details for: '@SelectedEndpoint.Name'</h6>
                </div>
                <div class="card-body p-2" style="font-size: 0.8rem;">
                    <div class="mb-1">
                        <strong>Template:</strong> <code class="text-info small">/@SelectedEndpoint.Endpoint | @SelectedEndpoint.HttpMethod</code>
                    </div>
                    @if (SelectedEndpoint.Parameters.Any())
                    {
                        <div class="mb-1">
                            <strong>Generated:</strong> <code class="text-primary small">/@GetFinalEndpoint()</code>
                        </div>
                    }
                    <div class="row mb-1">
                        <div class="col-5">
                            <strong>Table:</strong><br>
                            <code class="small">@SelectedEndpoint.TableName</code>
                        </div>
                        @if (!string.IsNullOrEmpty(SelectedEndpoint.Description))
                        {
                            <div class="col-7">
                                <strong>Description:</strong><br>
                                <small class="text-muted">@SelectedEndpoint.Description</small>
                            </div>
                        }
                    </div>
                    @if (SelectedEndpoint.Parameters.Any())
                    {
                        <div class="mb-1">
                            <strong>Params:</strong>
                            <span class="ms-1 font-monospace small">
                                @foreach (var param in SelectedEndpoint.Parameters)
                                {
                                    <span>@param.Name.ToUpper()=[Int32]</span>
                                }
                            </span>
                        </div>
                    }
                    @if (SelectedEndpoint.ResponseFields.Any())
                    {
                        <div>
                            <strong>Returns (@SelectedEndpoint.ResponseFields.Count fields):</strong>
                            <div class="font-monospace" style="background: #f8f9fa; padding: 3px 5px; border-radius: 2px; margin-top: 2px; font-size: 0.75rem; line-height: 1.2;">
                                @foreach (var field in SelectedEndpoint.ResponseFields)
                                {
                                    <div style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">@field.Name=@field.Type</div>
                                }
                            </div>
                        </div>
                    }
                </div>
            </div>
        }
    </div>
</div>

@if (ImportedData != null && ImportedData.Any())
{
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5>Imported Data from '@(SelectedEndpoint?.TableName)' (@ImportedData.Count() records)</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead>
                                <tr>
                                    @foreach (var column in GetTableColumns())
                                    {
                                        <th>@column</th>
                                    }
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var row in GetPagedData())
                                {
                                    <tr>
                                        @foreach (var column in GetTableColumns())
                                        {
                                            <td>@GetCellValue(row, column)</td>
                                        }
                                    </tr>
                                }
                            </tbody>
                        </table>
                        @if (GetTotalPages() > 1)
                        {
                            <div class="d-flex justify-content-between align-items-center mt-3">
                                <div>
                                    Showing @((CurrentPage - 1) * PageSize + 1) to @Math.Min(CurrentPage * PageSize, ImportedData.Count()) of @ImportedData.Count() records
                                </div>
                                <div>
                                    <button class="btn btn-sm btn-outline-primary me-2" 
                                            @onclick="PreviousPage" 
                                            disabled="@(CurrentPage == 1)">
                                        Previous
                                    </button>
                                    <span class="mx-2">Page @CurrentPage of @GetTotalPages()</span>
                                    <button class="btn btn-sm btn-outline-primary ms-2" 
                                            @onclick="NextPage" 
                                            disabled="@(CurrentPage >= GetTotalPages())">
                                        Next
                                    </button>
                                </div>
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>
}

@code {
    private string SelectedEndpointKey = "";
    private EndpointConfiguration? SelectedEndpoint = null;
    private Dictionary<string, string> ParameterValues = new();
    private Dictionary<string, IEnumerable<dynamic>> DropdownData = new();
    private string StatusMessage = "";
    private string LoadingMessage = "";
    private bool IsLoading => IsTesting || IsImporting || IsLoadingDropdowns;
    private bool IsTesting = false;
    private bool IsImporting = false;
    private bool IsLoadingDropdowns = false;
    private bool ShowViewData = false;
    private IEnumerable<dynamic>? ImportedData = null;
    private int CurrentPage = 1;
    private int PageSize = 100;
    
    private async Task TestConnection()
    {
        var endpoint = GetFinalEndpoint();
        if (string.IsNullOrEmpty(endpoint)) return;
        
        IsTesting = true;
        LoadingMessage = "Testing connection...";
        StatusMessage = "";
        StateHasChanged();
        
        try
        {
            var result = await ApiService.TestConnectionAsync(endpoint);
            StatusMessage = result.Success 
                ? $"‚úÖ Connected! Found {result.RecordCount} records."
                : $"‚ùå Failed: {result.ErrorMessage}";
        }
        catch (Exception ex)
        {
            StatusMessage = $"‚ùå Error: {ex.Message}";
        }
        finally
        {
            IsTesting = false;
            StateHasChanged();
        }
    }
    
    private async Task ImportData()
    {
        var endpoint = GetFinalEndpoint();
        if (string.IsNullOrEmpty(endpoint)) return;
        
        // Debug logging
        Console.WriteLine($"Importing endpoint: {endpoint}");
        foreach (var kv in ParameterValues)
        {
            Console.WriteLine($"Parameter {kv.Key} = {kv.Value}");
        }
        
        IsImporting = true;
        LoadingMessage = "Importing data...";
        StatusMessage = "";
        StateHasChanged();
        
        try
        {
            var result = await ImportService.ImportDataAsync(endpoint, overwriteExisting: true);
            if (result.Success)
            {
                StatusMessage = $"‚úÖ Imported {result.RecordsImported} records successfully into '{SelectedEndpoint?.TableName}' table!";
                ShowViewData = true;
                await LoadImportedData();
            }
            else
            {
                StatusMessage = $"‚ùå Import failed: {result.ErrorMessage}";
            }
        }
        catch (Exception ex)
        {
            StatusMessage = $"‚ùå Error: {ex.Message}";
        }
        finally
        {
            IsImporting = false;
            StateHasChanged();
        }
    }
    
    private string GetAlertClass()
    {
        if (StatusMessage.StartsWith("‚úÖ")) return "alert-success";
        if (StatusMessage.StartsWith("‚ùå")) return "alert-danger";
        return "alert-info";
    }
    
    private async Task ExportToCsv()
    {
        if (ImportedData == null || !ImportedData.Any())
        {
            StatusMessage = "‚ö†Ô∏è No data to export!";
            return;
        }
        
        try
        {
            var csv = new StringBuilder();
            var columns = GetTableColumns().ToList();
            
            // Add headers
            csv.AppendLine(string.Join(",", columns.Select(c => $"\"{c}\"")));
            
            // Add data rows
            foreach (var row in ImportedData)
            {
                var values = columns.Select(col => 
                {
                    var value = GetCellValue(row, col)?.ToString() ?? "";
                    // Escape quotes and wrap in quotes if contains comma or quotes
                    if (value.Contains(",") || value.Contains("\"") || value.Contains("\n"))
                    {
                        value = "\"" + value.Replace("\"", "\"\"") + "\"";
                    }
                    return value;
                });
                csv.AppendLine(string.Join(",", values));
            }
            
            // Download the CSV file
            var fileName = $"{SelectedEndpoint?.TableName}_{DateTime.Now:yyyyMMdd_HHmmss}.csv";
            var bytes = Encoding.UTF8.GetBytes(csv.ToString());
            var base64 = Convert.ToBase64String(bytes);
            
            await JS.InvokeVoidAsync("downloadFile", fileName, base64, "text/csv");
            StatusMessage = $"‚úÖ Exported {ImportedData.Count()} records to {fileName}";
        }
        catch (Exception ex)
        {
            StatusMessage = $"‚ùå Export failed: {ex.Message}";
        }
    }
    
    private async Task LoadImportedData()
    {
        if (SelectedEndpoint == null) return;
        
        try
        {
            ImportedData = await ImportService.GetImportedDataAsync(SelectedEndpoint.TableName);
            CurrentPage = 1; // Reset to first page when loading new data
            StateHasChanged();
        }
        catch (Exception ex)
        {
            StatusMessage = $"‚ùå Error loading data: {ex.Message}";
            StateHasChanged();
        }
    }
    
    private IEnumerable<dynamic> GetPagedData()
    {
        if (ImportedData == null) return Enumerable.Empty<dynamic>();
        return ImportedData.Skip((CurrentPage - 1) * PageSize).Take(PageSize);
    }
    
    private int GetTotalPages()
    {
        if (ImportedData == null || !ImportedData.Any()) return 1;
        return (int)Math.Ceiling((double)ImportedData.Count() / PageSize);
    }
    
    private void NextPage()
    {
        if (CurrentPage < GetTotalPages())
        {
            CurrentPage++;
            StateHasChanged();
        }
    }
    
    private void PreviousPage()
    {
        if (CurrentPage > 1)
        {
            CurrentPage--;
            StateHasChanged();
        }
    }
    
    private IEnumerable<string> GetTableColumns()
    {
        if (ImportedData == null || !ImportedData.Any()) return Enumerable.Empty<string>();
        
        var firstItem = ImportedData.First();
        if (firstItem is IDictionary<string, object> dict)
        {
            return dict.Keys.Where(k => k != "Id" && k != "CreatedDate" && k != "ModifiedDate");
        }
        
        // Cast to object first to avoid dynamic issues
        object obj = firstItem;
        var properties = obj.GetType().GetProperties();
        return properties
            .Where(p => p.Name != "Id" && p.Name != "CreatedDate" && p.Name != "ModifiedDate")
            .Select(p => p.Name);
    }
    
    private object GetCellValue(dynamic row, string columnName)
    {
        try
        {
            if (row is IDictionary<string, object> dict)
            {
                return dict.ContainsKey(columnName) ? dict[columnName]?.ToString() ?? "" : "";
            }
            
            var prop = row.GetType().GetProperty(columnName);
            return prop?.GetValue(row)?.ToString() ?? "";
        }
        catch
        {
            return "";
        }
    }
    
    private async Task OnEndpointChanged()
    {
        SelectedEndpoint = EndpointRegistry.AllEndpoints.FirstOrDefault(e => e.Key == SelectedEndpointKey);
        ParameterValues.Clear();
        DropdownData.Clear();
        ImportedData = null;
        ShowViewData = false;
        StatusMessage = "";
        CurrentPage = 1; // Reset pagination
        
        // Load dropdown data for parameters
        if (SelectedEndpoint != null)
        {
            StatusMessage = $"Loading parameters for: {SelectedEndpoint.Name}";
            await LoadDropdownData();
            
            // Debug: Show what endpoint will be called
            Console.WriteLine($"Selected endpoint: {SelectedEndpoint.Endpoint}");
        }
        
        await InvokeAsync(StateHasChanged);
    }
    
    private async Task LoadDropdownData()
    {
        if (SelectedEndpoint == null) return;
        
        foreach (var param in SelectedEndpoint.Parameters.Where(p => p.Type == "dropdown" && !string.IsNullOrEmpty(p.DropdownSource)))
        {
            if (!DropdownData.ContainsKey(param.DropdownSource!))
            {
                IsLoadingDropdowns = true;
                LoadingMessage = $"Loading {param.DropdownSource} data...";
                StateHasChanged();
                
                try
                {
                    // Load from database if already imported, otherwise fetch from API
                    var data = await ImportService.GetImportedDataAsync(param.DropdownSource!);
                    if (data == null || !data.Any())
                    {
                        // If no data in database, fetch from API
                        StatusMessage = $"üì• Fetching {param.DropdownSource} from API...";
                        StateHasChanged();
                        
                        var apiData = await ApiService.FetchDataAsync(param.DropdownSource!);
                        var deserializedData = Deserializer.DeserializeApiResponse(apiData, param.DropdownSource!);
                        
                        // Import to database for future use
                        await ImportService.ImportDataByEndpointAsync(param.DropdownSource!, deserializedData);
                        data = await ImportService.GetImportedDataAsync(param.DropdownSource!);
                        
                        StatusMessage = $"‚úÖ Loaded {data?.Count() ?? 0} {param.DropdownSource}";
                    }
                    else
                    {
                        StatusMessage = $"‚úÖ Loaded {data.Count()} {param.DropdownSource} from cache";
                    }
                    
                    DropdownData[param.DropdownSource!] = data ?? new List<dynamic>();
                }
                catch (Exception ex)
                {
                    StatusMessage = $"‚ö†Ô∏è Warning: Could not load {param.DropdownSource} data: {ex.Message}";
                    DropdownData[param.DropdownSource!] = new List<dynamic>(); // Empty list on error
                }
                finally
                {
                    IsLoadingDropdowns = false;
                    StateHasChanged();
                }
            }
        }
    }
    
    private string GetParameterValue(string paramName)
    {
        return ParameterValues.TryGetValue(paramName, out var value) ? value : "";
    }
    
    private void SetParameterValue(string paramName, string value)
    {
        ParameterValues[paramName] = value;
        Console.WriteLine($"SetParameterValue: {paramName} = {value}");
        StateHasChanged();
    }
    
    private string GetDropdownValue(dynamic item, string? valueField)
    {
        if (string.IsNullOrEmpty(valueField)) return "";
        
        try
        {
            if (item is IDictionary<string, object> dict && dict.ContainsKey(valueField))
            {
                return dict[valueField]?.ToString() ?? "";
            }
            
            object obj = item;
            var prop = obj.GetType().GetProperty(valueField);
            return prop?.GetValue(obj)?.ToString() ?? "";
        }
        catch
        {
            return "";
        }
    }
    
    private string GetDropdownDisplay(dynamic item, string? displayField)
    {
        if (string.IsNullOrEmpty(displayField)) return "";
        
        try
        {
            if (item is IDictionary<string, object> dict && dict.ContainsKey(displayField))
            {
                return dict[displayField]?.ToString() ?? "";
            }
            
            object obj = item;
            var prop = obj.GetType().GetProperty(displayField);
            return prop?.GetValue(obj)?.ToString() ?? "";
        }
        catch
        {
            return "";
        }
    }
    
    private string GetFinalEndpoint()
    {
        if (SelectedEndpoint == null) return "";
        
        var endpoint = SelectedEndpoint.Endpoint;
        
        // Replace parameters in the endpoint
        foreach (var param in SelectedEndpoint.Parameters)
        {
            if (ParameterValues.TryGetValue(param.Name, out var value) && !string.IsNullOrEmpty(value))
            {
                Console.WriteLine($"GetFinalEndpoint: Replacing {{{param.Name}}} with {value}");
                endpoint = endpoint.Replace($"{{{param.Name}}}", value);
            }
            else if (param.IsRequired)
            {
                Console.WriteLine($"GetFinalEndpoint: Missing required parameter {param.Name}");
                return ""; // Required parameter is missing
            }
        }
        
        Console.WriteLine($"GetFinalEndpoint: Final endpoint = {endpoint}");
        return endpoint;
    }
    
    private bool CanImport()
    {
        if (IsLoading) return false;
        if (SelectedEndpoint == null) return false;
        
        // Check all required parameters are filled
        foreach (var param in SelectedEndpoint.Parameters.Where(p => p.IsRequired))
        {
            if (!ParameterValues.TryGetValue(param.Name, out var value) || string.IsNullOrEmpty(value))
            {
                return false;
            }
        }
        
        return !string.IsNullOrEmpty(GetFinalEndpoint());
    }
}