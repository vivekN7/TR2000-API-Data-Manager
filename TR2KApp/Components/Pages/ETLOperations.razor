@page "/etl-operations"
@using TR2KBlazorLibrary.Logic.Services
@using TR2KBlazorLibrary.Models
@inject OracleETLServiceV2 ETLService
@inject ILogger<ETLOperations> Logger
@rendermode InteractiveServer

<h3>ETL Operations - TR2000 Data Management</h3>

<!-- Collapsible Knowledge Articles Section -->
<div class="card mb-3">
    <div class="card-header" style="background-color: #00346a; color: white; cursor: pointer;" @onclick="ToggleKnowledgeSection">
        <h6 class="mb-0">
            <i class="bi @(showKnowledgeSection ? "bi-chevron-down" : "bi-chevron-right")"></i> 
            Knowledge Articles & Documentation
            <small class="text-white-50 ms-2">(@(showKnowledgeSection ? "click to collapse" : "click to expand"))</small>
        </h6>
    </div>
    @if (showKnowledgeSection)
    {
        <div class="card-body">
            <!-- Understanding SCD2 -->
            <details class="mb-3">
                <summary class="h6 text-primary" style="cursor: pointer;">
                    <i class="bi bi-mortarboard"></i> Understanding SCD2 (Slowly Changing Dimension Type 2)
                </summary>
                <div class="mt-2 ps-3">
                    <p><strong>What is SCD2?</strong> A data warehousing technique that tracks historical changes by creating new records for each change while preserving old records.</p>
                    
                    <h6>Key Concepts:</h6>
                    <ul>
                        <li><strong>VALID_FROM/VALID_TO</strong>: Temporal boundaries showing when a record was active</li>
                        <li><strong>IS_CURRENT</strong>: Flag indicating the current version (Y/N)</li>
                        <li><strong>CHANGE_TYPE</strong>: Tracks the operation (INSERT, UPDATE, DELETE, REACTIVATE)</li>
                        <li><strong>SRC_HASH</strong>: SHA256 hash of all fields to detect changes</li>
                    </ul>

                    <h6>Our Implementation Handles:</h6>
                    <ol>
                        <li><strong>INSERT</strong>: New records from API â†’ Create with IS_CURRENT='Y'</li>
                        <li><strong>UPDATE</strong>: Changed records â†’ Close old (IS_CURRENT='N'), create new version</li>
                        <li><strong>DELETE</strong>: Missing from API or plant removed from loader â†’ Mark with DELETE_DATE, IS_CURRENT='N'</li>
                        <li><strong>REACTIVATE</strong>: Deleted record returns â†’ Create new version with CHANGE_TYPE='REACTIVATE'</li>
                        <li><strong>UNCHANGED</strong>: No changes detected â†’ Skip processing</li>
                    </ol>
                    
                    <div class="alert alert-warning mt-2">
                        <strong>ðŸ”„ Deletion Cascade:</strong> When a plant is removed from the Plant Loader, 
                        all its issues are automatically marked as deleted during the next Issues ETL run. 
                        This ensures downstream reference tables only process relevant data. If the plant 
                        is added back to the loader, its issues will be reactivated automatically.
                    </div>
                </div>
            </details>

            <!-- ETL Process Flow -->
            <details class="mb-3">
                <summary class="h6 text-success" style="cursor: pointer;">
                    <i class="bi bi-diagram-3"></i> ETL Process Flow
                </summary>
                <div class="mt-2 ps-3">
                    <h6>When you click "Load" buttons:</h6>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <h6 class="text-primary">Step 1: C# Service (Data Movement)</h6>
                            <ol>
                                <li>Fetch data from TR2000 API</li>
                                <li>Insert RAW_JSON for audit trail</li>
                                <li>Get next ETL_RUN_ID from sequence</li>
                                <li>Bulk insert into STG_* staging tables</li>
                                <li>Call SP_PROCESS_ETL_BATCH orchestrator</li>
                                <li>Return results to UI</li>
                            </ol>
                        </div>
                        <div class="col-md-6">
                            <h6 class="text-primary">Step 2: Oracle Orchestrator (Business Logic)</h6>
                            <ol>
                                <li><strong>Deduplication</strong>: Remove duplicates using STG_ID</li>
                                <li><strong>Validation</strong>: Check business rules</li>
                                <li><strong>SCD2 Processing</strong>: Apply temporal logic</li>
                                <li><strong>Reconciliation</strong>: Count source vs target</li>
                                <li><strong>Cleanup</strong>: Purge old history/logs</li>
                                <li><strong>COMMIT</strong>: Single atomic transaction</li>
                            </ol>
                        </div>
                    </div>

                    <div class="alert alert-warning mt-3">
                        <strong>Key Safety Features:</strong>
                        <ul class="mb-0">
                            <li>API data fetched BEFORE starting transaction (prevents locks)</li>
                            <li>Autonomous error logging (survives rollbacks)</li>
                            <li>All-or-nothing: Complete success or complete rollback</li>
                            <li>RAW_JSON audit trail with 30-day retention</li>
                        </ul>
                    </div>
                </div>
            </details>

            <!-- Complete Field Coverage Breakthrough -->
            <details class="mb-3">
                <summary class="h6 text-success" style="cursor: pointer;">
                    <i class="bi bi-trophy"></i> Complete Field Coverage Achievement (Session 20 Breakthrough)
                </summary>
                <div class="mt-2 ps-3">
                    <div class="alert alert-success">
                        <h6><i class="bi bi-check-circle"></i> <strong>Major Breakthrough Achieved!</strong></h6>
                        <p class="mb-0">Session 20 transformed our ETL from basic data capture (20% coverage) to comprehensive engineering data warehouse (100% coverage)</p>
                    </div>
                    
                    <h6>Field Coverage Improvements:</h6>
                    <div class="row">
                        <div class="col-md-6">
                            <h6 class="text-primary">PLANTS Table Enhancement</h6>
                            <ul>
                                <li><strong>Before</strong>: 5 fields (PlantID, Name, Description, OperatorID, CommonLibPlantCode)</li>
                                <li><strong>After</strong>: <span class="badge bg-success">24+ fields</span> including:</li>
                                <ul class="small mt-1">
                                    <li>Project, Area, Category information</li>
                                    <li>Configuration settings (EnableEmbeddedNote, OverLength)</li>
                                    <li>Engineering parameters (PCSQA, EDSMJ, CelsiusBar)</li>
                                    <li>Documentation links and remark texts</li>
                                    <li>Complete audit trail (UserProtected, InitialRevision)</li>
                                </ul>
                                <li><strong>Impact</strong>: <span class="text-danger">79% data loss eliminated</span></li>
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <h6 class="text-primary">ISSUES Table Enhancement</h6>
                            <ul>
                                <li><strong>Before</strong>: 3 fields (PlantID, IssueRevision, basic audit)</li>
                                <li><strong>After</strong>: <span class="badge bg-success">25+ fields</span> including:</li>
                                <ul class="small mt-1">
                                    <li>Complete revision tracking matrix (PCS, EDS, VDS, VSK, MDS, ESK, SC, VSM)</li>
                                    <li>Status and protection tracking</li>
                                    <li>Individual revision dates for all components</li>
                                    <li>General revision information</li>
                                    <li>Enhanced user audit trail</li>
                                </ul>
                                <li><strong>Impact</strong>: <span class="text-danger">88% data loss eliminated</span></li>
                            </ul>
                        </div>
                    </div>

                    <h6 class="mt-3">New PCS Engineering Data Tables:</h6>
                    <div class="row">
                        <div class="col-md-6">
                            <h6 class="text-warning">NEW: PCS_HEADER (15+ fields)</h6>
                            <ul class="small">
                                <li>Complete PCS properties and configuration</li>
                                <li>Design codes, material groups, rating classes</li>
                                <li>Test pressures and approval tracking</li>
                                <li>Special requirements and notepad content</li>
                            </ul>
                            
                            <h6 class="text-warning">NEW: PCS_PIPE_SIZES (11 fields)</h6>
                            <ul class="small">
                                <li>Nominal sizes and outer diameters</li>
                                <li>Wall thickness and schedule specifications</li>
                                <li>Tolerance and corrosion allowances</li>
                                <li>Welding factors and matrix indicators</li>
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <h6 class="text-warning">NEW: PCS_TEMP_PRESSURE (50+ fields)</h6>
                            <ul class="small">
                                <li>Complete temperature/pressure design matrix</li>
                                <li>12 temperature/pressure pairs for full operating envelope</li>
                                <li>Service remarks and revision tracking</li>
                                <li>Material group IDs and special requirements</li>
                            </ul>
                            
                            <h6 class="text-warning">NEW: PCS_PIPE_ELEMENTS (25+ fields)</h6>
                            <ul class="small">
                                <li>Detailed element specifications and dimensions</li>
                                <li>Materials, standards, and product forms</li>
                                <li>MDS/EDS/ESK linkages and revisions</li>
                                <li>Parent-child element relationships</li>
                            </ul>
                        </div>
                    </div>

                    <h6 class="mt-3">Enhanced Reference Tables:</h6>
                    <div class="alert alert-info">
                        <strong>All 6 reference types enhanced:</strong> VDS, EDS, MDS, VSK, ESK, SC, VSM, and Pipe Elements now include:
                        <ul class="mb-0 mt-2">
                            <li><strong>RevDate</strong>: Revision dates for complete temporal tracking</li>
                            <li><strong>Status</strong>: Current status of each referenced document</li>
                            <li><strong>Complete Metadata</strong>: Official revisions, deltas, user audit trails</li>
                            <li><strong>Specialized Fields</strong>: Area (MDS), Element Groups (Pipe Elements)</li>
                        </ul>
                    </div>

                    <h6 class="mt-3">Business Impact:</h6>
                    <div class="row">
                        <div class="col-md-4">
                            <div class="text-center p-3 border rounded">
                                <h2 class="text-success">100%</h2>
                                <small>API Field Coverage</small>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="text-center p-3 border rounded">
                                <h2 class="text-primary">100+</h2>
                                <small>Engineering Fields</small>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="text-center p-3 border rounded">
                                <h2 class="text-warning">4</h2>
                                <small>New PCS Tables</small>
                            </div>
                        </div>
                    </div>
                </div>
            </details>

            <!-- Oracle Database Objects -->
            <details class="mb-3">
                <summary class="h6 text-warning" style="cursor: pointer;">
                    <i class="bi bi-database"></i> Oracle Database Objects - Enhanced Schema
                </summary>
                <div class="mt-2 ps-3">
                    <div class="alert alert-success mb-3">
                        <i class="bi bi-check-circle"></i> <strong>Enhanced DDL (Session 20):</strong> 
                        Complete field coverage with 100+ engineering fields vs. previous minimal implementation
                    </div>

                    <div class="row">
                        <div class="col-md-3">
                            <h6>Enhanced Staging Tables</h6>
                            <ul class="small">
                                <li><code>STG_OPERATORS</code> <span class="badge bg-info">2 fields</span></li>
                                <li><code>STG_PLANTS</code> <span class="badge bg-success">24+ fields</span></li>
                                <li><code>STG_ISSUES</code> <span class="badge bg-success">25+ fields</span></li>
                                <li><code>STG_PCS_REFERENCES</code> <span class="badge bg-success">15+ fields</span></li>
                                <li><code>STG_*_REFERENCES</code> <span class="badge bg-info">All 6 types</span></li>
                                <li><code>STG_PCS_HEADER</code> <span class="badge bg-warning">NEW</span></li>
                                <li><code>STG_PCS_TEMP_PRESSURE</code> <span class="badge bg-warning">NEW</span></li>
                                <li><code>STG_PCS_PIPE_SIZES</code> <span class="badge bg-warning">NEW</span></li>
                                <li><code>STG_PCS_PIPE_ELEMENTS</code> <span class="badge bg-warning">NEW</span></li>
                                <li class="text-muted">Auto-cleared after ETL</li>
                            </ul>
                        </div>
                        <div class="col-md-3">
                            <h6>Enhanced Dimension Tables (SCD2)</h6>
                            <ul class="small">
                                <li><code>OPERATORS</code> <span class="badge bg-info">Minimal</span></li>
                                <li><code>PLANTS</code> <span class="badge bg-success">24+ fields</span></li>
                                <li><code>ISSUES</code> <span class="badge bg-success">25+ fields</span></li>
                                <li><code>PCS_REFERENCES</code> <span class="badge bg-success">15+ fields</span></li>
                                <li><code>VDS_REFERENCES</code> <span class="badge bg-success">Complete</span></li>
                                <li><code>EDS/MDS/VSK/ESK_REF</code> <span class="badge bg-info">All 5</span></li>
                                <li><code>PIPE_ELEMENT_REF</code> <span class="badge bg-success">Different structure</span></li>
                                <li><code>PCS_HEADER</code> <span class="badge bg-warning">NEW</span></li>
                                <li><code>PCS_TEMP_PRESSURE</code> <span class="badge bg-warning">NEW</span></li>
                                <li><code>PCS_PIPE_SIZES</code> <span class="badge bg-warning">NEW</span></li>
                                <li><code>PCS_PIPE_ELEMENTS</code> <span class="badge bg-warning">NEW</span></li>
                                <li class="text-muted">Full SCD2 history forever</li>
                            </ul>
                        </div>
                        <div class="col-md-3">
                            <h6>Control & Audit</h6>
                            <ul class="small">
                                <li><code>ETL_CONTROL</code></li>
                                <li><code>ETL_ERROR_LOG</code></li>
                                <li><code>ETL_PLANT_LOADER</code></li>
                                <li><code>ETL_ISSUE_LOADER</code></li>
                                <li><code>ETL_RECONCILIATION</code></li>
                                <li><code>RAW_JSON</code> <span class="badge bg-info">Compressed</span></li>
                                <li class="text-muted">Auto-cleanup active</li>
                            </ul>
                        </div>
                        <div class="col-md-3">
                            <h6>ETL Packages & Procedures</h6>
                            <ul class="small">
                                <li><code>SP_PROCESS_ETL_BATCH</code></li>
                                <li><code>PKG_OPERATORS_ETL</code></li>
                                <li><code>PKG_PLANTS_ETL</code></li>
                                <li><code>PKG_ISSUES_ETL</code></li>
                                <li><code>PKG_VDS_REF_ETL</code></li>
                                <li><code>PKG_EDS_REF_ETL</code></li>
                                <li><code>PKG_MDS_REF_ETL</code></li>
                                <li><code>PKG_VSK_REF_ETL</code></li>
                                <li><code>PKG_ESK_REF_ETL</code></li>
                                <li><code>PKG_PIPE_ELEMENT_REF_ETL</code></li>
                            </ul>
                        </div>
                    </div>
                    
                    <h6 class="mt-3">Enhanced Data Retention Policies:</h6>
                    <ul>
                        <li><strong>All Dimension Tables</strong>: <span class="badge bg-success">PERMANENT</span> - Complete SCD2 history preserved forever</li>
                        <li><strong>Enhanced Staging Tables</strong>: <span class="badge bg-secondary">TEMPORARY</span> - Cleared after successful ETL</li>
                        <li><strong>Engineering Data (PCS Details)</strong>: <span class="badge bg-success">PERMANENT</span> - Design pressures, temperatures, materials</li>
                        <li><strong>ETL_CONTROL</strong>: <span class="badge bg-secondary">10 RUNS</span> - Rolling window cleanup</li>
                        <li><strong>ETL_ERROR_LOG</strong>: <span class="badge bg-secondary">30 DAYS</span> - Autonomous error survival</li>
                        <li><strong>RAW_JSON</strong>: <span class="badge bg-secondary">30 DAYS</span> - Compressed audit trail</li>
                    </ul>
                </div>
            </details>

            <!-- Engineering Data Capabilities -->
            <details class="mb-3">
                <summary class="h6 text-info" style="cursor: pointer;">
                    <i class="bi bi-gear"></i> Engineering Data Capabilities
                </summary>
                <div class="mt-2 ps-3">
                    <div class="alert alert-info">
                        <h6><i class="bi bi-cpu"></i> <strong>Comprehensive Engineering Data Warehouse</strong></h6>
                        <p class="mb-0">The enhanced DDL transforms TR2000 ETL into a complete engineering data repository with design specifications, operating conditions, and material properties.</p>
                    </div>

                    <h6>Engineering Data Now Captured:</h6>
                    <div class="row">
                        <div class="col-md-6">
                            <h6 class="text-primary">Design Conditions & Operating Envelope</h6>
                            <ul class="small">
                                <li><strong>Design Pressures</strong>: 12-point pressure matrix for complete operating range</li>
                                <li><strong>Design Temperatures</strong>: 12-point temperature matrix with revision tracking</li>
                                <li><strong>Test Pressures</strong>: Hydrostatic test requirements</li>
                                <li><strong>Rating Classes</strong>: ANSI/API pressure class specifications</li>
                                <li><strong>Corrosion Allowances</strong>: Material degradation factors</li>
                                <li><strong>Service Conditions</strong>: Operating environment descriptions</li>
                            </ul>

                            <h6 class="text-primary">Materials & Specifications</h6>
                            <ul class="small">
                                <li><strong>Material Groups</strong>: Standardized material classifications</li>
                                <li><strong>Material Grades</strong>: Specific alloy and grade information</li>
                                <li><strong>Design Codes</strong>: Engineering standards (ASME, API, etc.)</li>
                                <li><strong>Product Forms</strong>: Pipe, fitting, flange specifications</li>
                                <li><strong>Dimensional Standards</strong>: Size and tolerance specifications</li>
                                <li><strong>Wall Thickness</strong>: Schedule and custom thickness data</li>
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <h6 class="text-success">Piping System Components</h6>
                            <ul class="small">
                                <li><strong>Pipe Sizes</strong>: Complete nominal size matrix with schedules</li>
                                <li><strong>Pipe Elements</strong>: Detailed component specifications</li>
                                <li><strong>Element Groups</strong>: Logical grouping of related components</li>
                                <li><strong>Welding Factors</strong>: Joint efficiency calculations</li>
                                <li><strong>Tolerance Specifications</strong>: Manufacturing tolerances</li>
                                <li><strong>Parent-Child Relationships</strong>: Component hierarchy tracking</li>
                            </ul>

                            <h6 class="text-success">Document Integration & References</h6>
                            <ul class="small">
                                <li><strong>Complete Reference Matrix</strong>: VDS, EDS, MDS, VSK, ESK, SC, VSM</li>
                                <li><strong>Revision Tracking</strong>: Individual component revision dates</li>
                                <li><strong>Status Monitoring</strong>: Current approval and protection status</li>
                                <li><strong>Official Revisions</strong>: Certified document versions</li>
                                <li><strong>Delta Tracking</strong>: Change indicators and modifications</li>
                                <li><strong>Cross-References</strong>: Complete document linkage</li>
                            </ul>
                        </div>
                    </div>

                    <h6 class="mt-3">Engineering Use Cases:</h6>
                    <div class="row">
                        <div class="col-md-4">
                            <div class="card">
                                <div class="card-header bg-primary text-white">
                                    <h6 class="mb-0"><i class="bi bi-calculator"></i> Pressure Vessel Design</h6>
                                </div>
                                <div class="card-body small">
                                    <ul class="mb-0">
                                        <li>Complete design pressure/temperature matrix</li>
                                        <li>Material properties and allowances</li>
                                        <li>Design code compliance tracking</li>
                                        <li>Test pressure requirements</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card">
                                <div class="card-header bg-success text-white">
                                    <h6 class="mb-0"><i class="bi bi-diagram-3"></i> Piping System Analysis</h6>
                                </div>
                                <div class="card-body small">
                                    <ul class="mb-0">
                                        <li>Complete pipe size and schedule matrix</li>
                                        <li>Wall thickness and tolerance data</li>
                                        <li>Element specifications and relationships</li>
                                        <li>Material grade and form tracking</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card">
                                <div class="card-header bg-warning text-white">
                                    <h6 class="mb-0"><i class="bi bi-file-earmark-check"></i> Document Management</h6>
                                </div>
                                <div class="card-body small">
                                    <ul class="mb-0">
                                        <li>Complete revision history tracking</li>
                                        <li>Cross-reference verification</li>
                                        <li>Status and approval monitoring</li>
                                        <li>Change impact analysis</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>

                    <h6 class="mt-3">Integration Capabilities:</h6>
                    <div class="alert alert-warning">
                        <strong><i class="bi bi-arrow-repeat"></i> Downstream System Integration:</strong>
                        <ul class="mb-0 mt-2">
                            <li><strong>CAD Systems</strong>: Complete pipe specifications for 3D modeling</li>
                            <li><strong>Stress Analysis</strong>: Design conditions and material properties</li>
                            <li><strong>Procurement</strong>: Material specifications and vendor requirements</li>
                            <li><strong>Construction</strong>: Installation procedures and test requirements</li>
                            <li><strong>Maintenance</strong>: Operating conditions and inspection schedules</li>
                            <li><strong>Compliance</strong>: Design code adherence and audit trails</li>
                        </ul>
                    </div>

                    <div class="text-center mt-3">
                        <div class="d-inline-block p-3 border rounded bg-light">
                            <h5 class="text-primary mb-1">Complete Engineering Data Ecosystem</h5>
                            <small class="text-muted">From basic ETL to comprehensive engineering data warehouse</small>
                        </div>
                    </div>
                </div>
            </details>

            <!-- Enhanced Entity Relationship Diagram -->
            <details class="mb-3">
                <summary class="h6 text-primary" style="cursor: pointer;">
                    <i class="bi bi-diagram-2"></i> Enhanced Entity Relationship Diagram
                </summary>
                <div class="mt-2 ps-3">
                    <div class="alert alert-primary">
                        <h6><i class="bi bi-diagram-2"></i> <strong>Enhanced Database Schema Overview</strong></h6>
                        <p class="mb-0">Complete view of enhanced staging and dimension tables with relationships and complete field coverage</p>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <h6 class="text-primary">Control & Configuration Tables</h6>
                            <div class="card mb-3">
                                <div class="card-header bg-light">
                                    <strong>ETL_CONTROL</strong>
                                </div>
                                <div class="card-body small">
                                    <ul class="mb-0">
                                        <li>ETL_RUN_ID (PK)</li>
                                        <li>RUN_TYPE, STATUS</li>
                                        <li>START_TIME, END_TIME</li>
                                        <li>PROCESSING_TIME_SEC</li>
                                        <li>RECORDS_LOADED/UPDATED/UNCHANGED/DELETED/REACTIVATED</li>
                                        <li>ERROR_COUNT, API_CALL_COUNT</li>
                                    </ul>
                                </div>
                            </div>

                            <div class="card mb-3">
                                <div class="card-header bg-light">
                                    <strong>ETL_PLANT_LOADER</strong>
                                </div>
                                <div class="card-body small">
                                    <ul class="mb-0">
                                        <li>PLANT_ID (PK)</li>
                                        <li>PLANT_NAME</li>
                                        <li>IS_ACTIVE</li>
                                        <li>LOAD_PRIORITY</li>
                                        <li>CREATED_DATE, CREATED_BY</li>
                                    </ul>
                                </div>
                            </div>

                            <div class="card mb-3">
                                <div class="card-header bg-light">
                                    <strong>ETL_ISSUE_LOADER</strong>
                                </div>
                                <div class="card-body small">
                                    <ul class="mb-0">
                                        <li>PLANT_ID, ISSUE_REVISION (PK)</li>
                                        <li>PLANT_NAME</li>
                                        <li>CREATED_DATE</li>
                                        <li><em>FK: ETL_PLANT_LOADER</em></li>
                                    </ul>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <h6 class="text-success">Enhanced Master Data Tables (SCD2)</h6>
                            <div class="card mb-3">
                                <div class="card-header bg-success text-white">
                                    <strong>PLANTS</strong> <span class="badge bg-light text-dark">24+ Fields</span>
                                </div>
                                <div class="card-body small">
                                    <ul class="mb-0">
                                        <li><strong>Core:</strong> PLANT_ID, OPERATOR_ID, OPERATOR_NAME</li>
                                        <li><strong>Enhanced:</strong> PROJECT, AREA, CATEGORY</li>
                                        <li><strong>Config:</strong> ENABLE_EMBEDDED_NOTE, PCS_QA, EDS_MJ</li>
                                        <li><strong>Extended:</strong> WEB_INFO_TEXT, BOLT_TENSION_TEXT</li>
                                        <li><strong>SCD2:</strong> VALID_FROM, VALID_TO, IS_CURRENT, CHANGE_TYPE</li>
                                    </ul>
                                </div>
                            </div>

                            <div class="card mb-3">
                                <div class="card-header bg-success text-white">
                                    <strong>ISSUES</strong> <span class="badge bg-light text-dark">25+ Fields</span>
                                </div>
                                <div class="card-body small">
                                    <ul class="mb-0">
                                        <li><strong>Core:</strong> PLANT_ID, ISSUE_REVISION</li>
                                        <li><strong>Status:</strong> STATUS, REV_DATE, PROTECT_STATUS</li>
                                        <li><strong>Matrix:</strong> PCS/EDS/VDS/VSK/MDS/ESK/SC/VSM_REVISION</li>
                                        <li><strong>Dates:</strong> PCS/EDS/VDS/VSK/MDS/ESK/SC/VSM_REV_DATE</li>
                                        <li><strong>SCD2:</strong> VALID_FROM, VALID_TO, IS_CURRENT, CHANGE_TYPE</li>
                                    </ul>
                                </div>
                            </div>

                            <div class="card mb-3">
                                <div class="card-header bg-info text-white">
                                    <strong>OPERATORS</strong> <span class="badge bg-light text-dark">Minimal</span>
                                </div>
                                <div class="card-body small">
                                    <ul class="mb-0">
                                        <li>OPERATOR_ID, OPERATOR_NAME</li>
                                        <li><strong>SCD2:</strong> VALID_FROM, VALID_TO, IS_CURRENT</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>

                    <h6 class="text-warning mt-3">NEW: Enhanced Reference Tables (SCD2)</h6>
                    <div class="row">
                        <div class="col-md-4">
                            <div class="card mb-2">
                                <div class="card-header bg-warning text-dark small">
                                    <strong>PCS_REFERENCES</strong>
                                </div>
                                <div class="card-body small">
                                    <ul class="mb-0">
                                        <li>PCS_NAME, PCS_REVISION</li>
                                        <li><strong>Enhanced:</strong> REV_DATE, STATUS</li>
                                        <li>OFFICIAL_REVISION, RATING_CLASS</li>
                                        <li>MATERIAL_GROUP, HISTORICAL_PCS</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card mb-2">
                                <div class="card-header bg-warning text-dark small">
                                    <strong>VDS/EDS/MDS/VSK/ESK_REFERENCES</strong>
                                </div>
                                <div class="card-body small">
                                    <ul class="mb-0">
                                        <li>*_NAME, *_REVISION</li>
                                        <li><strong>Enhanced:</strong> REV_DATE, STATUS</li>
                                        <li>OFFICIAL_REVISION, DELTA</li>
                                        <li><strong>MDS:</strong> +AREA field</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card mb-2">
                                <div class="card-header bg-warning text-dark small">
                                    <strong>PIPE_ELEMENT_REFERENCES</strong>
                                </div>
                                <div class="card-body small">
                                    <ul class="mb-0">
                                        <li>ELEMENT_GROUP, DIMENSION_STANDARD</li>
                                        <li>PRODUCT_FORM, MATERIAL_GRADE</li>
                                        <li>MDS, MDS_REVISION, AREA</li>
                                        <li>ELEMENT_ID, REVISION</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>

                    <h6 class="text-danger mt-3">NEW: PCS Engineering Tables (100+ Fields)</h6>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card mb-2">
                                <div class="card-header bg-danger text-white small">
                                    <strong>PCS_HEADER</strong> <span class="badge bg-light text-dark">15+ Fields</span>
                                </div>
                                <div class="card-body small">
                                    <ul class="mb-0">
                                        <li>PCS_NAME, PCS_REVISION, STATUS</li>
                                        <li>RATING_CLASS, TEST_PRESSURE</li>
                                        <li>MATERIAL_GROUP, DESIGN_CODE</li>
                                        <li>APPROVER, NOTEPAD, SPECIAL_REQ_ID</li>
                                    </ul>
                                </div>
                            </div>

                            <div class="card mb-2">
                                <div class="card-header bg-danger text-white small">
                                    <strong>PCS_PIPE_SIZES</strong> <span class="badge bg-light text-dark">11 Fields</span>
                                </div>
                                <div class="card-body small">
                                    <ul class="mb-0">
                                        <li>NOM_SIZE, OUTER_DIAM</li>
                                        <li>WALL_THICKNESS, SCHEDULE</li>
                                        <li>CORROSION_ALLOWANCE, WELDING_FACTOR</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card mb-2">
                                <div class="card-header bg-danger text-white small">
                                    <strong>PCS_TEMP_PRESSURE</strong> <span class="badge bg-light text-dark">50+ Fields</span>
                                </div>
                                <div class="card-body small">
                                    <ul class="mb-0">
                                        <li><strong>Matrix:</strong> DESIGN_PRESS_01-12</li>
                                        <li><strong>Matrix:</strong> DESIGN_TEMP_01-12</li>
                                        <li>CORR_ALLOWANCE, LONG_WELD_EFF</li>
                                        <li>SERVICE_REMARK, NOTE_ID_* fields</li>
                                    </ul>
                                </div>
                            </div>

                            <div class="card mb-2">
                                <div class="card-header bg-danger text-white small">
                                    <strong>PCS_PIPE_ELEMENTS</strong> <span class="badge bg-light text-dark">25+ Fields</span>
                                </div>
                                <div class="card-body small">
                                    <ul class="mb-0">
                                        <li>ELEMENT, DIM_STANDARD</li>
                                        <li>MATERIAL, PRODUCT_FORM</li>
                                        <li>MDS, EDS, ESK references</li>
                                        <li>PARENT_ELEMENT, ITEM_CODE</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="alert alert-info mt-3">
                        <h6><i class="bi bi-info-circle"></i> <strong>All SCD2 Tables Include:</strong></h6>
                        <div class="row">
                            <div class="col-md-6">
                                <ul class="small mb-0">
                                    <li><strong>SRC_HASH</strong> - SHA256 change detection</li>
                                    <li><strong>VALID_FROM/VALID_TO</strong> - Temporal boundaries</li>
                                    <li><strong>IS_CURRENT</strong> - Current version flag</li>
                                </ul>
                            </div>
                            <div class="col-md-6">
                                <ul class="small mb-0">
                                    <li><strong>CHANGE_TYPE</strong> - INSERT/UPDATE/DELETE/REACTIVATE</li>
                                    <li><strong>DELETE_DATE</strong> - Soft delete tracking</li>
                                    <li><strong>ETL_RUN_ID</strong> - Batch processing ID</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <div class="text-center mt-3">
                        <div class="alert alert-success">
                            <h5><i class="bi bi-check-circle"></i> <strong>Enhanced Schema Benefits</strong></h5>
                            <div class="row">
                                <div class="col-md-4">
                                    <h6 class="text-success">100% API Coverage</h6>
                                    <small>All TR2000 fields captured</small>
                                </div>
                                <div class="col-md-4">
                                    <h6 class="text-primary">100+ Engineering Fields</h6>
                                    <small>Complete design specifications</small>
                                </div>
                                <div class="col-md-4">
                                    <h6 class="text-warning">4 New PCS Tables</h6>
                                    <small>Detailed engineering data</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </details>

            <!-- Table Structure Documentation -->
            <details class="mb-3">
                <summary class="h6 text-secondary" style="cursor: pointer;">
                    <i class="bi bi-table"></i> Enhanced Table Structure Reference
                </summary>
                <div class="mt-2 ps-3">
                    <div class="alert alert-secondary">
                        <h6><i class="bi bi-info-circle"></i> <strong>Complete Field Reference</strong></h6>
                        <p class="mb-0">Enhanced DDL provides complete field coverage for all TR2000 API endpoints. This reference shows the complete table structures now available.</p>
                    </div>

                    <!-- Enhanced Master Data Tables -->
                    <h6>Enhanced Master Data Tables:</h6>
                    <div class="accordion" id="tableStructureAccordion">
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="plantsTableHeader">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#plantsTableBody">
                                    <strong>PLANTS Table (24+ Fields)</strong> <span class="badge bg-success ms-2">Enhanced</span>
                                </button>
                            </h2>
                            <div id="plantsTableBody" class="accordion-collapse collapse" data-bs-parent="#tableStructureAccordion">
                                <div class="accordion-body">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <h6 class="text-primary">Core Plant Fields</h6>
                                            <ul class="small">
                                                <li><code>OPERATOR_ID</code> - Plant operator identifier</li>
                                                <li><code>OPERATOR_NAME</code> - Operator company name</li>
                                                <li><code>PLANT_ID</code> - Unique plant identifier</li>
                                                <li><code>SHORT_DESCRIPTION</code> - Brief plant name</li>
                                                <li><code>PROJECT</code> - Associated project name</li>
                                                <li><code>LONG_DESCRIPTION</code> - Complete plant description</li>
                                                <li><code>COMMON_LIB_PLANT_CODE</code> - Standard plant code</li>
                                                <li><code>INITIAL_REVISION</code> - First revision identifier</li>
                                                <li><code>AREA_ID</code> - Geographic area identifier</li>
                                                <li><code>AREA</code> - Geographic area name</li>
                                            </ul>
                                        </div>
                                        <div class="col-md-6">
                                            <h6 class="text-success">Configuration & Settings</h6>
                                            <ul class="small">
                                                <li><code>ENABLE_EMBEDDED_NOTE</code> - Note embedding settings</li>
                                                <li><code>CATEGORY_ID</code> - Plant category identifier</li>
                                                <li><code>CATEGORY</code> - Plant category description</li>
                                                <li><code>DOCUMENT_SPACE_LINK</code> - Documentation portal link</li>
                                                <li><code>ENABLE_COPY_PCS_FROM_PLANT</code> - PCS copy settings</li>
                                                <li><code>OVER_LENGTH</code> - Over-length pipe settings</li>
                                                <li><code>PCS_QA</code> - Quality assurance settings</li>
                                                <li><code>EDS_MJ</code> - EDS MJ matrix settings</li>
                                                <li><code>CELSIUS_BAR</code> - Unit system settings</li>
                                                <li><code>WEB_INFO_TEXT</code> - Web portal information</li>
                                                <li><code>BOLT_TENSION_TEXT</code> - Bolt tension procedures</li>
                                                <li><code>VISIBLE</code> - Plant visibility settings</li>
                                                <li><code>WINDOWS_REMARK_TEXT</code> - Windows application remarks</li>
                                                <li><code>USER_PROTECTED</code> - User protection level</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="accordion-item">
                            <h2 class="accordion-header" id="issuesTableHeader">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#issuesTableBody">
                                    <strong>ISSUES Table (25+ Fields)</strong> <span class="badge bg-success ms-2">Enhanced</span>
                                </button>
                            </h2>
                            <div id="issuesTableBody" class="accordion-collapse collapse" data-bs-parent="#tableStructureAccordion">
                                <div class="accordion-body">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <h6 class="text-primary">Status & General Information</h6>
                                            <ul class="small">
                                                <li><code>PLANT_ID</code> - Associated plant identifier</li>
                                                <li><code>ISSUE_REVISION</code> - Issue revision number</li>
                                                <li><code>STATUS</code> - Current issue status</li>
                                                <li><code>REV_DATE</code> - Revision date</li>
                                                <li><code>PROTECT_STATUS</code> - Protection status</li>
                                                <li><code>GENERAL_REVISION</code> - General revision number</li>
                                                <li><code>GENERAL_REV_DATE</code> - General revision date</li>
                                                <li><code>USER_NAME</code> - User who created/modified</li>
                                                <li><code>USER_ENTRY_TIME</code> - Entry timestamp</li>
                                                <li><code>USER_PROTECTED</code> - User protection level</li>
                                            </ul>
                                        </div>
                                        <div class="col-md-6">
                                            <h6 class="text-success">Component Revision Matrix</h6>
                                            <ul class="small">
                                                <li><code>PCS_REVISION</code> / <code>PCS_REV_DATE</code> - PCS revisions</li>
                                                <li><code>EDS_REVISION</code> / <code>EDS_REV_DATE</code> - EDS revisions</li>
                                                <li><code>VDS_REVISION</code> / <code>VDS_REV_DATE</code> - VDS revisions</li>
                                                <li><code>VSK_REVISION</code> / <code>VSK_REV_DATE</code> - VSK revisions</li>
                                                <li><code>MDS_REVISION</code> / <code>MDS_REV_DATE</code> - MDS revisions</li>
                                                <li><code>ESK_REVISION</code> / <code>ESK_REV_DATE</code> - ESK revisions</li>
                                                <li><code>SC_REVISION</code> / <code>SC_REV_DATE</code> - SC revisions</li>
                                                <li><code>VSM_REVISION</code> / <code>VSM_REV_DATE</code> - VSM revisions</li>
                                            </ul>
                                            <div class="alert alert-info mt-2">
                                                <small><strong>Complete Tracking:</strong> Individual revision numbers and dates for all 8 component types provide comprehensive change history.</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="accordion-item">
                            <h2 class="accordion-header" id="pcsTablesHeader">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#pcsTablesBody">
                                    <strong>NEW: PCS Engineering Tables (100+ Fields)</strong> <span class="badge bg-warning ms-2">NEW</span>
                                </button>
                            </h2>
                            <div id="pcsTablesBody" class="accordion-collapse collapse" data-bs-parent="#tableStructureAccordion">
                                <div class="accordion-body">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <h6 class="text-warning">PCS_HEADER (15+ fields)</h6>
                                            <ul class="small">
                                                <li><code>STATUS</code> / <code>REV_DATE</code> - Document status tracking</li>
                                                <li><code>RATING_CLASS</code> - ANSI/API pressure rating</li>
                                                <li><code>TEST_PRESSURE</code> - Hydrostatic test requirements</li>
                                                <li><code>MATERIAL_GROUP</code> - Material classification</li>
                                                <li><code>DESIGN_CODE</code> - Engineering standard (ASME, API)</li>
                                                <li><code>LAST_UPDATE</code> / <code>LAST_UPDATE_BY</code> - Change tracking</li>
                                                <li><code>APPROVER</code> - Document approver</li>
                                                <li><code>NOTEPAD</code> - Engineering notes</li>
                                                <li><code>SPECIAL_REQ_ID</code> - Special requirements</li>
                                                <li><code>TUBE_PCS</code> / <code>NEW_VDS_SECTION</code> - Configuration</li>
                                            </ul>

                                            <h6 class="text-warning">PCS_PIPE_SIZES (11 fields)</h6>
                                            <ul class="small">
                                                <li><code>NOM_SIZE</code> - Nominal pipe size</li>
                                                <li><code>OUTER_DIAM</code> - Outside diameter</li>
                                                <li><code>WALL_THICKNESS</code> - Wall thickness</li>
                                                <li><code>SCHEDULE</code> - Pipe schedule</li>
                                                <li><code>UNDER_TOLERANCE</code> - Negative tolerance</li>
                                                <li><code>CORROSION_ALLOWANCE</code> - Corrosion allowance</li>
                                                <li><code>WELDING_FACTOR</code> - Joint efficiency</li>
                                                <li><code>DIM_ELEMENT_CHANGE</code> - Dimension changes</li>
                                                <li><code>SCHEDULE_IN_MATRIX</code> - Matrix inclusion</li>
                                            </ul>
                                        </div>
                                        <div class="col-md-6">
                                            <h6 class="text-warning">PCS_TEMP_PRESSURE (50+ fields)</h6>
                                            <ul class="small">
                                                <li><code>DESIGN_PRESS_01-12</code> - 12-point pressure matrix</li>
                                                <li><code>DESIGN_TEMP_01-12</code> - 12-point temperature matrix</li>
                                                <li><code>CORR_ALLOWANCE</code> / <code>_REV_MARK</code> - Corrosion data</li>
                                                <li><code>LONG_WELD_EFF</code> / <code>_REV_MARK</code> - Welding efficiency</li>
                                                <li><code>WALL_THK_TOL</code> / <code>_REV_MARK</code> - Thickness tolerance</li>
                                                <li><code>SERVICE_REMARK</code> / <code>_REV_MARK</code> - Service conditions</li>
                                                <li><code>NOTE_ID_*</code> - Note reference fields</li>
                                                <li><code>MATERIAL_GROUP_ID</code> - Material group reference</li>
                                                <li><code>EDS_MJ_MATRIX</code> - EDS MJ matrix settings</li>
                                                <li><code>MJ_REDUCTION_FACTOR</code> - Reduction factors</li>
                                            </ul>

                                            <h6 class="text-warning">PCS_PIPE_ELEMENTS (25+ fields)</h6>
                                            <ul class="small">
                                                <li><code>MATERIAL_GROUP_ID</code> / <code>ELEMENT_GROUP_NO</code> - Grouping</li>
                                                <li><code>ELEMENT</code> - Element description</li>
                                                <li><code>DIM_STANDARD</code> - Dimensional standard</li>
                                                <li><code>FROM_SIZE</code> / <code>TO_SIZE</code> - Size range</li>
                                                <li><code>PRODUCT_FORM</code> - Product type</li>
                                                <li><code>MATERIAL</code> - Material specification</li>
                                                <li><code>MDS</code> / <code>MDS_REVISION</code> - Material datasheet</li>
                                                <li><code>EDS</code> / <code>EDS_REVISION</code> - Element datasheet</li>
                                                <li><code>ESK</code> - Element sketch reference</li>
                                                <li><code>PARENT_ELEMENT</code> - Hierarchy relationship</li>
                                                <li><code>ITEM_CODE</code> - Item classification</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <h6 class="mt-3">All SCD2 Tables Include:</h6>
                    <div class="alert alert-info">
                        <div class="row">
                            <div class="col-md-6">
                                <h6 class="text-primary">Temporal Tracking Fields</h6>
                                <ul class="small mb-0">
                                    <li><code>VALID_FROM</code> - When record became active</li>
                                    <li><code>VALID_TO</code> - When record became inactive</li>
                                    <li><code>IS_CURRENT</code> - Current version flag (Y/N)</li>
                                    <li><code>CHANGE_TYPE</code> - INSERT/UPDATE/DELETE/REACTIVATE</li>
                                    <li><code>DELETE_DATE</code> - When deleted from source</li>
                                </ul>
                            </div>
                            <div class="col-md-6">
                                <h6 class="text-success">Audit & Control Fields</h6>
                                <ul class="small mb-0">
                                    <li><code>SRC_HASH</code> - SHA256 hash for change detection</li>
                                    <li><code>ETL_RUN_ID</code> - Batch processing identifier</li>
                                    <li><code>PRIMARY KEY</code> - Business key + VALID_FROM</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </details>
        </div>
    }
</div>

@if (!string.IsNullOrEmpty(statusMessage))
{
    <div class="alert @(statusMessage.Contains("Error") ? "alert-danger" : statusMessage.Contains("Success") ? "alert-success" : "alert-info")">
        @statusMessage
    </div>
}

<!-- SQL Preview Modal -->
@if (showSqlPreview && currentSqlPreview != null)
{
    <div class="modal show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog modal-xl modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        @currentSqlPreview.Title
                    </h5>
                    <button type="button" class="btn-close" @onclick="() => showSqlPreview = false"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle"></i> <strong>What happens when you click Load:</strong>
                        <br/>@currentSqlPreview.Description
                    </div>

                    @foreach (var step in currentSqlPreview.Steps)
                    {
                        <div class="card mb-3">
                            <div class="card-header bg-light">
                                <h6 class="mb-0">
                                    Step @step.StepNumber: @step.Title
                                </h6>
                            </div>
                            <div class="card-body">
                                <p class="text-muted">@step.Description</p>
                                <pre class="bg-dark text-light p-3 rounded" style="font-size: 0.9rem; overflow-x: auto;">@step.SqlStatement</pre>
                            </div>
                        </div>
                    }

                    <div class="alert alert-warning">
                        <h6><i class="bi bi-shield-check"></i> Data Integrity Features:</h6>
                        <ul>
                            <li><strong>Atomic Transactions</strong>: All-or-nothing processing</li>
                            <li><strong>Autonomous Error Logging</strong>: Errors recorded even if transaction rolls back</li>
                            <li><strong>Hash-based Change Detection</strong>: Only changed records are processed</li>
                            <li><strong>Soft Deletes</strong>: Records never physically deleted, marked with DELETE_DATE</li>
                            <li><strong>Full Audit Trail</strong>: Every change tracked with CHANGE_TYPE and timestamps</li>
                        </ul>
                    </div>

                    <div class="alert alert-success">
                        <h6><i class="bi bi-clock-history"></i> Enhanced Data Retention Policies:</h6>
                        <ul>
                            <li><strong>Enhanced Master Tables</strong>: <span class="badge bg-success">PERMANENT</span> - OPERATORS, PLANTS (24+ fields), ISSUES (25+ fields)</li>
                            <li><strong>Enhanced Reference Tables</strong>: <span class="badge bg-success">PERMANENT</span> - All 6 reference types with complete metadata</li>
                            <li><strong>NEW: PCS Engineering Tables</strong>: <span class="badge bg-success">PERMANENT</span> - 4 tables with 100+ engineering fields</li>
                            <li><strong>Enhanced Staging Tables</strong>: <span class="badge bg-secondary">TEMPORARY</span> - Complete field coverage, cleared after successful run</li>
                            <li><strong>ETL_CONTROL</strong>: <span class="badge bg-secondary">10 RUNS</span> - Rolling window cleanup (automatic)</li>
                            <li><strong>ETL_ERROR_LOG</strong>: <span class="badge bg-secondary">30 DAYS</span> - Autonomous error survival (automatic)</li>
                            <li><strong>RAW_JSON</strong>: <span class="badge bg-secondary">30 DAYS</span> - Compressed audit trail (automatic)</li>
                        </ul>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="() => showSqlPreview = false">
                        <i class="bi bi-x"></i> Close
                    </button>
                    <button type="button" class="btn btn-primary" @onclick="ExecuteAfterPreview" disabled="@isLoading">
                        <i class="bi bi-play-fill"></i> Execute Now
                    </button>
                </div>
            </div>
        </div>
    </div>
}

<div class="row">
    <!-- Section 1: Database Setup -->
    <div class="col-md-6">
        <div class="card mb-3">
            <div class="card-header" style="background-color: #00346a; color: white;">
                <h6 class="mb-0">1. Database Setup</h6>
            </div>
            <div class="card-body">
                <button class="btn btn-outline-primary mb-2" @onclick="TestConnection" disabled="@isLoading">
                    Test Connection
                </button>
                
                @if (connectionStatus)
                {
                    <small class="text-success d-block">âœ… Connected to Oracle</small>
                }
            </div>
        </div>
    </div>

    <!-- Section 2: Plant Loader Configuration -->
    <div class="col-md-6">
        <div class="card mb-3">
            <div class="card-header" style="background-color: #00346a; color: white;">
                <h6 class="mb-0">2. Plant Loader Configuration (Scope Control)</h6>
            </div>
            <div class="card-body">
                @if (!plantLoaderTableExists)
                {
                    <div class="alert alert-warning small">
                        Plant loader table doesn't exist yet.
                    </div>
                    <button class="btn btn-outline-primary mb-2" @onclick="CreatePlantLoaderTable" disabled="@isLoading">
                        Create Plant Loader Table
                    </button>
                }
                else
                {
                    <div class="mb-3">
                        <label class="form-label small">Add Plant to Loader:</label>
                        <div class="input-group input-group-sm">
                            <select class="form-select" @bind="selectedPlantToAdd" disabled="@isLoading">
                                <option value="">-- Select Plant --</option>
                                @foreach (var plant in availablePlants)
                                {
                                    <option value="@plant.PlantID">@plant.PlantName (@plant.PlantID)</option>
                                }
                            </select>
                            <button class="btn btn-outline-primary" @onclick="AddPlantToLoader" disabled="@(isLoading || string.IsNullOrEmpty(selectedPlantToAdd))">
                                Add
                            </button>
                        </div>
                    </div>

                    @if (plantLoaderEntries != null && plantLoaderEntries.Any())
                    {
                        <h6 class="small">Plants to Process for Issues ETL:</h6>
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Plant</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var entry in plantLoaderEntries)
                                {
                                    <tr>
                                        <td class="small">@entry.PlantName (@entry.PlantID)</td>
                                        <td>
                                            <button class="btn btn-sm btn-link text-danger p-0" @onclick="() => RemovePlantFromLoader(entry.PlantID)" disabled="@isLoading">
                                                Remove
                                            </button>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                        <small class="text-muted">
                            @plantLoaderEntries.Count plant(s) will be processed when loading issues.
                        </small>
                    }
                    else
                    {
                        <p class="small text-muted">No plants configured yet. Add plants above to control which ones are processed during Issues ETL.</p>
                    }
                }
            </div>
        </div>
    </div>
</div>

<!-- Section 2.5: Issue Loader Configuration (Reference Scope Control) -->
<div class="card mb-3">
    <div class="card-header" style="background-color: #00346a; color: white;">
        <h6 class="mb-0">2.5. Issue Loader Configuration (Reference Tables Scope)</h6>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-12">
                @if (!issueLoaderTableExists)
                {
                    <div class="alert alert-warning small">
                        Issue loader table doesn't exist yet.
                    </div>
                    <button class="btn btn-outline-primary mb-2" @onclick="CreateIssueLoaderTable" disabled="@isLoading">
                        Create Issue Loader Table
                    </button>
                }
                else
                {
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label small">Select Plant:</label>
                            <select class="form-select form-select-sm" value="@selectedPlantForIssues" @onchange="OnPlantSelectedForIssues" disabled="@isLoading">
                                <option value="">-- Select Plant --</option>
                                @foreach (var entry in plantLoaderEntries ?? new List<PlantLoaderEntry>())
                                {
                                    <option value="@entry.PlantID">@entry.PlantName (@entry.PlantID)</option>
                                }
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label small">Select Issue Revision:</label>
                            <div class="input-group input-group-sm">
                                <select class="form-select" @bind="selectedIssueRevision" disabled="@(isLoading || string.IsNullOrEmpty(selectedPlantForIssues))">
                                    <option value="">-- Select Issue --</option>
                                    @foreach (var issue in availableIssues)
                                    {
                                        <option value="@issue.IssueRevision">@issue.IssueRevision</option>
                                    }
                                </select>
                                <button class="btn btn-outline-primary" @onclick="AddIssueToLoader" disabled="@(isLoading || string.IsNullOrEmpty(selectedPlantForIssues) || string.IsNullOrEmpty(selectedIssueRevision))">
                                    Add
                                </button>
                            </div>
                        </div>
                    </div>

                    @if (issueLoaderEntries != null && issueLoaderEntries.Any())
                    {
                        <h6 class="small">Issues Selected for Reference Loading:</h6>
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Plant</th>
                                    <th>Issue Revision</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var entry in issueLoaderEntries)
                                {
                                    <tr>
                                        <td class="small">@entry.PlantName (@entry.PlantID)</td>
                                        <td class="small">@entry.IssueRevision</td>
                                        <td>
                                            <button class="btn btn-sm btn-link text-danger p-0" @onclick="() => RemoveIssueFromLoader(entry.PlantID, entry.IssueRevision)" disabled="@isLoading">
                                                Remove
                                            </button>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                        <small class="text-muted">
                            @issueLoaderEntries.Count issue(s) selected. When present in this table, their reference tables will be loaded (API optimization: ~70% fewer calls).
                        </small>
                    }
                    else
                    {
                        <p class="small text-muted">No issues configured yet. Select issues above to control which reference tables are loaded.</p>
                    }
                }
            </div>
        </div>
    </div>
</div>

<!-- Section 3: Master Data ETL -->
<div class="card mb-3">
    <div class="card-header" style="background-color: #00346a; color: white;">
        <h6 class="mb-0">3. Master Data ETL</h6>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-4">
                <div class="d-flex gap-2 mb-2">
                    <button class="btn btn-primary btn-sm" @onclick="LoadOperators" disabled="@isLoading">
                        Load Operators
                    </button>
                    <button class="btn btn-outline-secondary btn-sm" @onclick='() => ShowSqlPreview("operators")' disabled="@isLoading">
                        Preview SQL
                    </button>
                </div>
            </div>
            <div class="col-md-4">
                <div class="d-flex gap-2 mb-2">
                    <button class="btn btn-primary btn-sm" @onclick="LoadPlants" disabled="@isLoading">
                        Load Plants
                    </button>
                    <button class="btn btn-outline-secondary btn-sm" @onclick='() => ShowSqlPreview("plants")' disabled="@isLoading">
                        Preview SQL
                    </button>
                </div>
            </div>
            <div class="col-md-4">
                <div class="d-flex gap-2 mb-2">
                    <button class="btn btn-primary btn-sm" @onclick="LoadIssues" disabled="@isLoading">
                        Load Issues
                    </button>
                    <button class="btn btn-outline-secondary btn-sm" @onclick='() => ShowSqlPreview("issues")' disabled="@isLoading">
                        Preview SQL
                    </button>
                </div>
                <small class="text-muted">Uses plants from loader</small>
            </div>
        </div>
    </div>
</div>

<!-- Section 4: Reference Data ETL -->
<div class="card mb-3">
    <div class="card-header" style="background-color: #00346a; color: white;">
        <h6 class="mb-0">4. Reference Data ETL</h6>
    </div>
    <div class="card-body">
        <!-- VDS References -->
        <div class="row mb-3">
            <div class="col-md-4">
                <div class="d-flex gap-2 mb-2">
                    <button class="btn btn-success btn-sm" @onclick="LoadVDSReferences" disabled="@isLoading">
                        Load VDS References
                    </button>
                    <button class="btn btn-outline-secondary btn-sm" @onclick='() => ShowSqlPreview("vds_references")' disabled="@isLoading">
                        Preview SQL
                    </button>
                </div>
                <small class="text-muted">Uses issues from Issue Loader (70% fewer API calls)</small>
            </div>
            <div class="col-md-8">
                <div class="alert alert-info small mb-0">
                    <strong>VDS References:</strong> Loads Valve Data Sheet references for all issues in the Issue Loader. 
                    Includes cascade deletion - references for removed issues are automatically marked as deleted.
                </div>
            </div>
        </div>
        
        <!-- EDS References -->
        <div class="row mb-3">
            <div class="col-md-4">
                <div class="d-flex gap-2 mb-2">
                    <button class="btn btn-success btn-sm" @onclick="LoadEDSReferences" disabled="@isLoading">
                        Load EDS References
                    </button>
                    <button class="btn btn-outline-secondary btn-sm" @onclick='() => ShowSqlPreview("eds_references")' disabled="@isLoading">
                        Preview SQL
                    </button>
                </div>
                <small class="text-muted">Uses issues from Issue Loader (70% fewer API calls)</small>
            </div>
            <div class="col-md-8">
                <div class="alert alert-info small mb-0">
                    <strong>EDS References:</strong> Loads Equipment Data Sheet references for all issues in the Issue Loader. 
                    Includes cascade deletion - references for removed issues are automatically marked as deleted.
                </div>
            </div>
        </div>
        
        <!-- MDS References -->
        <div class="row mb-3">
            <div class="col-md-4">
                <div class="d-flex gap-2 mb-2">
                    <button class="btn btn-success btn-sm" @onclick="LoadMDSReferences" disabled="@isLoading">
                        Load MDS References
                    </button>
                    <button class="btn btn-outline-secondary btn-sm" @onclick='() => ShowSqlPreview("mds_references")' disabled="@isLoading">
                        Preview SQL
                    </button>
                </div>
                <small class="text-muted">Uses issues from Issue Loader (70% fewer API calls)</small>
            </div>
            <div class="col-md-8">
                <div class="alert alert-info small mb-0">
                    <strong>MDS References:</strong> Loads Material Data Sheet references for all issues in the Issue Loader (includes Area field). 
                    Includes cascade deletion - references for removed issues are automatically marked as deleted.
                </div>
            </div>
        </div>
        
        <!-- VSK References -->
        <div class="row mb-3">
            <div class="col-md-4">
                <div class="d-flex gap-2 mb-2">
                    <button class="btn btn-success btn-sm" @onclick="LoadVSKReferences" disabled="@isLoading">
                        Load VSK References
                    </button>
                    <button class="btn btn-outline-secondary btn-sm" @onclick='() => ShowSqlPreview("vsk_references")' disabled="@isLoading">
                        Preview SQL
                    </button>
                </div>
                <small class="text-muted">Uses issues from Issue Loader (70% fewer API calls)</small>
            </div>
            <div class="col-md-8">
                <div class="alert alert-info small mb-0">
                    <strong>VSK References:</strong> Loads Valve Sketch references for all issues in the Issue Loader. 
                    Includes cascade deletion - references for removed issues are automatically marked as deleted.
                </div>
            </div>
        </div>
        
        <!-- ESK References -->
        <div class="row mb-3">
            <div class="col-md-4">
                <div class="d-flex gap-2 mb-2">
                    <button class="btn btn-success btn-sm" @onclick="LoadESKReferences" disabled="@isLoading">
                        Load ESK References
                    </button>
                    <button class="btn btn-outline-secondary btn-sm" @onclick='() => ShowSqlPreview("esk_references")' disabled="@isLoading">
                        Preview SQL
                    </button>
                </div>
                <small class="text-muted">Uses issues from Issue Loader (70% fewer API calls)</small>
            </div>
            <div class="col-md-8">
                <div class="alert alert-info small mb-0">
                    <strong>ESK References:</strong> Loads Equipment Sketch references for all issues in the Issue Loader. 
                    Includes cascade deletion - references for removed issues are automatically marked as deleted.
                </div>
            </div>
        </div>
        
        <!-- Pipe Element References -->
        <div class="row">
            <div class="col-md-4">
                <div class="d-flex gap-2 mb-2">
                    <button class="btn btn-success btn-sm" @onclick="LoadPipeElementReferences" disabled="@isLoading">
                        Load Pipe Element References
                    </button>
                    <button class="btn btn-outline-secondary btn-sm" @onclick='() => ShowSqlPreview("pipe_element_references")' disabled="@isLoading">
                        Preview SQL
                    </button>
                </div>
                <small class="text-muted">Uses issues from Issue Loader (70% fewer API calls)</small>
            </div>
            <div class="col-md-8">
                <div class="alert alert-info small mb-0">
                    <strong>Pipe Element References:</strong> Loads Pipe Element references for all issues in the Issue Loader (different structure with Tag, Type, Size, Rating, Material). 
                    Includes cascade deletion - references for removed issues are automatically marked as deleted.
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Section 5: Current Table Status -->
<div class="card mb-3">
    <div class="card-header" style="background-color: #00346a; color: white;">
        <h6 class="mb-0">5. Current Table Status</h6>
    </div>
    <div class="card-body">
        <button class="btn btn-sm btn-secondary mb-2" @onclick="RefreshStatus" disabled="@isLoading">
            Refresh Status
        </button>
        
        @if (tableStatuses != null && tableStatuses.Any())
        {
            <table class="table table-sm">
                <thead>
                    <tr>
                        <th>Table</th>
                        <th>Current Records</th>
                        <th>Historical Records</th>
                        <th>Total</th>
                        <th>Last Modified</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var status in tableStatuses)
                    {
                        <tr>
                            <td>@status.TableName</td>
                            <td><span class="badge bg-success">@status.CurrentRows</span></td>
                            <td><span class="badge bg-secondary">@status.HistoricalRows</span></td>
                            <td><span class="badge bg-primary">@status.TotalRows</span></td>
                            <td>@status.LastModified?.ToString("yyyy-MM-dd HH:mm:ss")</td>
                        </tr>
                    }
                </tbody>
            </table>
        }
    </div>
</div>


<!-- Section 6: ETL History -->
<div class="card mb-3">
    <div class="card-header" style="background-color: #00346a; color: white;">
        <h6 class="mb-0">6. ETL Run History</h6>
    </div>
    <div class="card-body">
        @if (etlHistory != null && etlHistory.Any())
        {
            <table class="table table-sm table-striped">
                <thead>
                    <tr>
                        <th>Run ID</th>
                        <th>Type</th>
                        <th>Status</th>
                        <th>Start Time</th>
                        <th>Duration (s)</th>
                        <th>Loaded</th>
                        <th>Updated</th>
                        <th>Deleted</th>
                        <th>Reactivated</th>
                        <th>Unchanged</th>
                        <th>API Calls</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var run in etlHistory)
                    {
                        <tr class="@(run.Status == "SUCCESS" ? "" : "table-danger")">
                            <td>@run.RunId</td>
                            <td>@run.RunType</td>
                            <td>
                                <span class="badge @(run.Status == "SUCCESS" ? "bg-success" : "bg-danger")">
                                    @run.Status
                                </span>
                            </td>
                            <td>@run.StartTime?.ToString("HH:mm:ss")</td>
                            <td>@run.ProcessingTimeSeconds?.ToString("F2")</td>
                            <td>@run.RecordsLoaded</td>
                            <td>@run.RecordsUpdated</td>
                            <td>@run.RecordsDeleted</td>
                            <td>@run.RecordsReactivated</td>
                            <td>@run.RecordsUnchanged</td>
                            <td>@run.ApiCallCount</td>
                        </tr>
                    }
                </tbody>
            </table>
        }
        else
        {
            <p>No ETL runs yet.</p>
        }
    </div>
</div>

<!-- Loading Spinner -->
@if (isLoading)
{
    <div class="text-center">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <p>@loadingMessage</p>
    </div>
}

@code {
    private bool isLoading = false;
    private string statusMessage = "";
    private string loadingMessage = "";
    private bool connectionStatus = false;
    private bool showSqlPreview = false;
    private bool showKnowledgeSection = false;  // Start collapsed
    private ETLSqlPreview? currentSqlPreview = null;
    private string currentPreviewEntity = "";
    
    // Plant Loader variables
    private bool plantLoaderTableExists = false;
    private string selectedPlantToAdd = "";
    private List<PlantLoaderEntry> plantLoaderEntries = new List<PlantLoaderEntry>();
    private List<Plant> availablePlants = new List<Plant>();
    
    // Issue Loader variables
    private bool issueLoaderTableExists = false;
    private string selectedPlantForIssues = "";
    private string selectedIssueRevision = "";
    private List<IssueLoaderEntry> issueLoaderEntries = new List<IssueLoaderEntry>();
    private List<Issue> availableIssues = new List<Issue>();
    
    private List<TableStatus> tableStatuses = new List<TableStatus>();
    private List<ETLRunHistory> etlHistory = new List<ETLRunHistory>();

    protected override async Task OnInitializedAsync()
    {
        await RefreshStatus();
        await CheckPlantLoaderStatus();
        await CheckIssueLoaderStatus();
    }
    
    private void ToggleKnowledgeSection()
    {
        showKnowledgeSection = !showKnowledgeSection;
    }
    
    private async Task CheckPlantLoaderStatus()
    {
        try
        {
            plantLoaderTableExists = await ETLService.CheckPlantLoaderTableExists();
            if (plantLoaderTableExists)
            {
                await LoadPlantLoaderData();
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to check plant loader status");
        }
    }
    
    private async Task LoadPlantLoaderData()
    {
        try
        {
            plantLoaderEntries = await ETLService.GetPlantLoaderEntries();
            availablePlants = await ETLService.GetAllPlants();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to load plant loader data");
        }
    }
    
    private async Task CreatePlantLoaderTable()
    {
        isLoading = true;
        loadingMessage = "Creating plant loader table...";
        statusMessage = "";
        
        try
        {
            await ETLService.CreatePlantLoaderTable();
            plantLoaderTableExists = true;
            await LoadPlantLoaderData();
            statusMessage = "âœ… Plant loader table created successfully";
        }
        catch (Exception ex)
        {
            statusMessage = $"Error creating plant loader table: {ex.Message}";
            Logger.LogError(ex, "Failed to create plant loader table");
        }
        finally
        {
            isLoading = false;
        }
    }
    
    private async Task AddPlantToLoader()
    {
        if (string.IsNullOrEmpty(selectedPlantToAdd)) return;
        
        isLoading = true;
        loadingMessage = "Adding plant to loader...";
        
        try
        {
            await ETLService.AddPlantToLoader(selectedPlantToAdd);
            await LoadPlantLoaderData();
            selectedPlantToAdd = "";
            statusMessage = "âœ… Plant added to loader successfully";
        }
        catch (Exception ex)
        {
            statusMessage = $"Error adding plant: {ex.Message}";
            Logger.LogError(ex, "Failed to add plant to loader");
        }
        finally
        {
            isLoading = false;
        }
    }
    
    // REMOVED: Active/Inactive concept removed for simplicity
    // All plants in the loader are processed - simpler design
    // private async Task TogglePlantActive(string plantId)
    // {
    //     // Method removed - no longer needed
    // }
    
    private async Task RemovePlantFromLoader(string plantId)
    {
        isLoading = true;
        loadingMessage = "Removing plant from loader...";
        
        try
        {
            await ETLService.RemovePlantFromLoader(plantId);
            await LoadPlantLoaderData();
            // Refresh Issue Loader to show cascade deletion in UI
            if (issueLoaderTableExists)
            {
                await LoadIssueLoaderData();
            }
            statusMessage = "âœ… Plant removed from loader (issues cascade deleted)";
        }
        catch (Exception ex)
        {
            statusMessage = $"Error removing plant: {ex.Message}";
            Logger.LogError(ex, "Failed to remove plant");
        }
        finally
        {
            isLoading = false;
        }
    }

    #region Issue Loader Methods

    private async Task CheckIssueLoaderStatus()
    {
        try
        {
            issueLoaderTableExists = await ETLService.CheckIssueLoaderTableExists();
            if (issueLoaderTableExists)
            {
                await LoadIssueLoaderData();
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to check issue loader status");
        }
    }

    private async Task LoadIssueLoaderData()
    {
        try
        {
            issueLoaderEntries = await ETLService.GetIssueLoaderEntries();
            StateHasChanged(); // Refresh UI after loading issue loader data
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to load issue loader data");
        }
    }

    private async Task CreateIssueLoaderTable()
    {
        isLoading = true;
        loadingMessage = "Creating issue loader table...";
        
        try
        {
            await ETLService.CreateIssueLoaderTable();
            issueLoaderTableExists = true;
            await LoadIssueLoaderData();
            statusMessage = "âœ… Issue loader table created successfully";
        }
        catch (Exception ex)
        {
            statusMessage = $"Error creating issue loader table: {ex.Message}";
            Logger.LogError(ex, "Failed to create issue loader table");
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task OnPlantSelectedForIssues(ChangeEventArgs e)
    {
        selectedPlantForIssues = e.Value?.ToString() ?? "";
        selectedIssueRevision = ""; // Reset issue selection
        
        if (!string.IsNullOrEmpty(selectedPlantForIssues))
        {
            try
            {
                availableIssues = await ETLService.GetIssuesForPlant(selectedPlantForIssues);
            }
            catch (Exception ex)
            {
                Logger.LogError(ex, "Failed to load issues for plant {PlantId}", selectedPlantForIssues);
                availableIssues = new List<Issue>();
            }
        }
        else
        {
            availableIssues = new List<Issue>();
        }
        
        StateHasChanged();
    }

    private async Task AddIssueToLoader()
    {
        isLoading = true;
        loadingMessage = "Adding issue to loader...";
        
        try
        {
            await ETLService.AddIssueToLoader(selectedPlantForIssues, selectedIssueRevision);
            await LoadIssueLoaderData();
            selectedIssueRevision = ""; // Reset selection
            statusMessage = "âœ… Issue added to loader";
        }
        catch (Exception ex)
        {
            statusMessage = $"Error adding issue: {ex.Message}";
            Logger.LogError(ex, "Failed to add issue");
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task RemoveIssueFromLoader(string plantId, string issueRevision)
    {
        isLoading = true;
        loadingMessage = "Removing issue from loader...";
        
        try
        {
            await ETLService.RemoveIssueFromLoader(plantId, issueRevision);
            await LoadIssueLoaderData();
            statusMessage = "âœ… Issue removed from loader";
        }
        catch (Exception ex)
        {
            statusMessage = $"Error removing issue: {ex.Message}";
            Logger.LogError(ex, "Failed to remove issue");
        }
        finally
        {
            isLoading = false;
        }
    }


    #endregion

    private async Task TestConnection()
    {
        isLoading = true;
        loadingMessage = "Testing Oracle connection...";
        statusMessage = "";
        
        try
        {
            connectionStatus = await ETLService.TestConnection();
            statusMessage = connectionStatus ? 
                "âœ… Successfully connected to Oracle database" : 
                "âŒ Failed to connect to Oracle database";
        }
        catch (Exception ex)
        {
            statusMessage = $"Error: {ex.Message}";
            Logger.LogError(ex, "Connection test failed");
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task LoadOperators()
    {
        isLoading = true;
        loadingMessage = "Loading operators with SCD2 processing...";
        statusMessage = "";
        
        try
        {
            var result = await ETLService.LoadOperators();
            
            if (result.Status == "SUCCESS")
            {
                statusMessage = $"âœ… Success: {result.Message}";
            }
            else
            {
                statusMessage = $"âš ï¸ {result.Status}: {result.Message}";
            }
            
            await RefreshStatus();
        }
        catch (Exception ex)
        {
            statusMessage = $"Error: {ex.Message}";
            Logger.LogError(ex, "Failed to load operators");
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task LoadPlants()
    {
        isLoading = true;
        loadingMessage = "Loading plants with SCD2 processing...";
        statusMessage = "";
        
        try
        {
            var result = await ETLService.LoadPlants();
            
            if (result.Status == "SUCCESS")
            {
                statusMessage = $"âœ… Success: {result.Message}";
                // Refresh plant loader dropdown after successful plant load
                if (plantLoaderTableExists)
                {
                    await LoadPlantLoaderData();
                    StateHasChanged(); // Force UI refresh
                }
            }
            else
            {
                statusMessage = $"âš ï¸ {result.Status}: {result.Message}";
            }
            
            await RefreshStatus();
        }
        catch (Exception ex)
        {
            statusMessage = $"Error: {ex.Message}";
            Logger.LogError(ex, "Failed to load plants");
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task LoadIssues()
    {
        isLoading = true;
        loadingMessage = "Loading issues with SCD2 processing...";
        statusMessage = "";
        
        try
        {
            var result = await ETLService.LoadIssuesForSelectedPlants();
            
            if (result.Status == "SUCCESS")
            {
                statusMessage = $"âœ… Success: {result.Message}";
            }
            else
            {
                statusMessage = $"âš ï¸ {result.Status}: {result.Message}";
            }
            
            await RefreshStatus();
        }
        catch (Exception ex)
        {
            statusMessage = $"Error: {ex.Message}";
            Logger.LogError(ex, "Failed to load issues");
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task LoadVDSReferences()
    {
        isLoading = true;
        loadingMessage = "Loading VDS references...";
        
        try
        {
            var result = await ETLService.LoadVDSReferences();
            statusMessage = result.Status == "SUCCESS" ? $"âœ… {result.Message}" : $"âŒ {result.Message}";
            await RefreshStatus();
        }
        catch (Exception ex)
        {
            statusMessage = $"Error: {ex.Message}";
            Logger.LogError(ex, "Failed to load VDS references");
        }
        finally
        {
            isLoading = false;
        }
    }
    
    private async Task LoadEDSReferences()
    {
        isLoading = true;
        loadingMessage = "Loading EDS references...";
        
        try
        {
            var result = await ETLService.LoadEDSReferences();
            statusMessage = result.Status == "SUCCESS" ? $"âœ… {result.Message}" : $"âŒ {result.Message}";
            await RefreshStatus();
        }
        catch (Exception ex)
        {
            statusMessage = $"Error: {ex.Message}";
            Logger.LogError(ex, "Failed to load EDS references");
        }
        finally
        {
            isLoading = false;
        }
    }
    
    private async Task LoadMDSReferences()
    {
        isLoading = true;
        loadingMessage = "Loading MDS references...";
        
        try
        {
            var result = await ETLService.LoadMDSReferences();
            statusMessage = result.Status == "SUCCESS" ? $"âœ… {result.Message}" : $"âŒ {result.Message}";
            await RefreshStatus();
        }
        catch (Exception ex)
        {
            statusMessage = $"Error: {ex.Message}";
            Logger.LogError(ex, "Failed to load MDS references");
        }
        finally
        {
            isLoading = false;
        }
    }
    
    private async Task LoadVSKReferences()
    {
        isLoading = true;
        loadingMessage = "Loading VSK references...";
        
        try
        {
            var result = await ETLService.LoadVSKReferences();
            statusMessage = result.Status == "SUCCESS" ? $"âœ… {result.Message}" : $"âŒ {result.Message}";
            await RefreshStatus();
        }
        catch (Exception ex)
        {
            statusMessage = $"Error: {ex.Message}";
            Logger.LogError(ex, "Failed to load VSK references");
        }
        finally
        {
            isLoading = false;
        }
    }
    
    private async Task LoadESKReferences()
    {
        isLoading = true;
        loadingMessage = "Loading ESK references...";
        
        try
        {
            var result = await ETLService.LoadESKReferences();
            statusMessage = result.Status == "SUCCESS" ? $"âœ… {result.Message}" : $"âŒ {result.Message}";
            await RefreshStatus();
        }
        catch (Exception ex)
        {
            statusMessage = $"Error: {ex.Message}";
            Logger.LogError(ex, "Failed to load ESK references");
        }
        finally
        {
            isLoading = false;
        }
    }
    
    private async Task LoadPipeElementReferences()
    {
        isLoading = true;
        loadingMessage = "Loading Pipe Element references...";
        
        try
        {
            var result = await ETLService.LoadPipeElementReferences();
            statusMessage = result.Status == "SUCCESS" ? $"âœ… {result.Message}" : $"âŒ {result.Message}";
            await RefreshStatus();
        }
        catch (Exception ex)
        {
            statusMessage = $"Error: {ex.Message}";
            Logger.LogError(ex, "Failed to load Pipe Element references");
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task RefreshStatus()
    {
        try
        {
            tableStatuses = await ETLService.GetTableStatuses();
            etlHistory = await ETLService.GetETLHistory(10);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to refresh status");
        }
    }

    private void ShowSqlPreview(string entity)
    {
        currentPreviewEntity = entity;
        showSqlPreview = true;
        
        currentSqlPreview = entity switch
        {
            "operators" => ETLService.GetOperatorsSqlPreview(),
            "plants" => ETLService.GetPlantsSqlPreview(),
            "issues" => ETLService.GetIssuesSqlPreview(),
            "vds_references" => ETLService.GetVDSReferencesSqlPreview(),
            "eds_references" => ETLService.GetEDSReferencesSqlPreview(),
            "mds_references" => ETLService.GetMDSReferencesSqlPreview(),
            "vsk_references" => ETLService.GetVSKReferencesSqlPreview(),
            "esk_references" => ETLService.GetESKReferencesSqlPreview(),
            "pipe_element_references" => ETLService.GetPipeElementReferencesSqlPreview(),
            _ => null
        };
    }

    private async Task ExecuteAfterPreview()
    {
        showSqlPreview = false;
        
        await Task.Yield(); // Allow UI to update
        
        switch (currentPreviewEntity)
        {
            case "operators":
                await LoadOperators();
                break;
            case "plants":
                await LoadPlants();
                break;
            case "issues":
                await LoadIssues();
                break;
            case "vds_references":
                await LoadVDSReferences();
                break;
        }
    }
}